<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5">
  <meta name="description" content="Plataforma de subastas online con tienda virtual integrada">
  <meta name="theme-color" content="#ff3e7f">
  
  <title>Subasta Argenta DEMO</title>
  
  <!-- Preconnect para optimizar carga -->
  <link rel="preconnect" href="https://cdn.tailwindcss.com">
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <link rel="preconnect" href="https://cdnjs.cloudflare.com">
  <link rel="preconnect" href="https://www.gstatic.com">
  
  <!-- Estilos -->
 <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio"></script>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
  
  <!-- MercadoPago SDK -->
  <!-- Google Maps API -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD-Np6TWWMqjV85eOaM0zkRobPUJJ6uc-8&libraries=places&loading=async" async defer></script>

  
  <style>
    :root {
      --primary: #ff3e7f;
      --primary-dark: #e83672;
      --secondary: #ff9d00;
      --accent: #00d4ff;
      --success: #00ff88;
      --warning: #ffcc00;
      --danger: #ff3860;
      --dark: #0f0f23;
      --dark-light: #1a1a2e;
      --text: #f0f0f5;
      --text-light: #a0a0b0;
    }
    
    * {
      -webkit-tap-highlight-color: rgba(255, 62, 127, 0.3);
    }
    
  
    body {
      background: linear-gradient(135deg, var(--dark) 0%, var(--dark-light) 100%);
      font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto;
      min-height: 100vh;
      color: var(--text);
      overflow-x: hidden;
      position: relative;
    }
    
    #particles-js {
      position: fixed;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      z-index: -1;
    }
    
    .glass {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px) saturate(180%);
      border: 1px solid rgba(255, 255, 255, 0.15);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }
    
    .glass-light {
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(15px) saturate(160%);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .logo {
      width: 50px;
      height: 50px;
      border-radius: 12px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      color: white;
      box-shadow: 0 5px 15px rgba(255, 62, 127, 0.5);
      animation: logoGlow 3s ease-in-out infinite alternate;
    }
    
    @keyframes logoGlow {
      0% { box-shadow: 0 5px 15px rgba(255, 62, 127, 0.5); }
      100% { box-shadow: 0 5px 25px rgba(255, 62, 127, 0.8), 0 0 30px rgba(255, 62, 127, 0.4); }
    }
    
    .countdown.pulse { 
      animation: pulse 1.5s infinite; 
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); box-shadow: 0 0 15px rgba(255, 204, 0, 0.8); }
      100% { transform: scale(1); }
    }
    
    .fade-in {
      animation: fadeIn 0.6s ease both;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(15px); }
      to { opacity: 1; transform: none; }
    }
    
    .slide-in {
      animation: slideIn 0.5s ease both;
    }
    
    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-20px); }
      to { opacity: 1; transform: none; }
    }
    
    .auction-card, .product-card {
      transition: all 0.4s ease;
      border-left: 4px solid transparent;
      position: relative;
      overflow: hidden;
      touch-action: manipulation;
    }
    
    .auction-card::before, .product-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
      transition: left 0.6s;
    }
    
    .auction-card:hover::before, .product-card:hover::before {
      left: 100%;
    }
    
    .auction-card:hover, .product-card:hover {
      transform: translateY(-5px) scale(1.01);
      border-left-color: var(--primary);
      box-shadow: 0 15px 30px rgba(0, 0, 0, 0.4);
    }
    .product-card {
  cursor: pointer;
  transition: all 0.4s ease;
}

.product-card:active {
  transform: translateY(-3px) scale(0.99);
}
    
    .btn-primary {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      border: none;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(255, 62, 127, 0.4);
      touch-action: manipulation;
    }
    
    .btn-primary::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      transition: left 0.5s;
    }
    
    .btn-primary:hover::before {
      left: 100%;
    }
    
    .btn-primary:active {
      transform: scale(0.95);
    }
    
    .btn-primary:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(255, 62, 127, 0.6);
    }
    
    .btn-outline-light {
      border-color: rgba(255, 255, 255, 0.3);
      color: var(--text);
      transition: all 0.3s ease;
      touch-action: manipulation;
    }
    
    .btn-outline-light:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.5);
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(255, 255, 255, 0.2);
    }
    
    .btn-outline-light:active {
      transform: scale(0.95);
    }
    
    .badge {
      font-size: 0.7rem;
      padding: 0.3rem 0.6rem;
    }
    
    .filter-section {
      transition: all 0.3s ease;
    }
    
    .filter-toggle {
      display: none;
    }
    
    @media (max-width: 768px) {
  body {
    padding-bottom: 5rem !important;
  }
  
  /* Header móvil */
  header {
    padding: 0.75rem !important;
  }
  
  .logo-container {
    width: 50px !important;
    height: 50px !important;
  }
  
  .logo-img-enhanced {
    width: 50px !important;
    height: 50px !important;
    padding: 6px !important;
  }
  
  .header-title {
    font-size: 1rem !important;
    line-height: 1.2 !important;
  }
  
  /* Botones del header */
  #authButtonsContainer button {
    min-width: 44px !important;
    padding: 0.5rem 0.4rem !important;
    font-size: 0.75rem !important;
  }
  
  .btn-sm {
    padding: 0.4rem 0.5rem !important;
    font-size: 0.75rem !important;
    min-height: 38px;
  }
  
  /* Subasta destacada */
  #featuredAuction {
    margin-bottom: 1rem !important;
  }
  
  #featuredAuction .glass-light {
    padding: 1rem !important;
  }
  
  #featuredAuction h3 {
    font-size: 1rem !important;
  }
  
  #featuredAuction h4 {
    font-size: 1.1rem !important;
  }
  
  /* Tarjetas de precio y tiempo */
  .price-tag {
    font-size: 1.25rem !important;
    line-height: 1.2 !important;
  }
  .price-tag {
  font-weight: 700;
  font-size: 1.25rem;
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  background-clip: text;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

/* Nuevo estilo para valores de subasta destacada */
.featured-value {
  font-weight: 800;
  font-size: 1.5rem;
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  background-clip: text;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  line-height: 1.2;
  font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto;
}

@media (max-width: 768px) {
  .featured-value {
    font-size: 1.3rem !important;
  }
}

@media (max-width: 480px) {
  .featured-value {
    font-size: 1.15rem !important;
  }
}
  
  /* Filtros */
  .filter-content input,
  .filter-content select {
    padding: 0.5rem 0.75rem !important;
    font-size: 0.875rem !important;
  }

  .filter-content label {
    font-size: 0.75rem !important;
    margin-bottom: 0.25rem !important;
  }
  
  .text-xs {
    font-size: 0.75rem !important;
  }
  
  .badge {
    font-size: 0.7rem !important;
    padding: 0.2rem 0.5rem !important;
  }
  
  .category-tag {
    font-size: 0.7rem !important;
    padding: 0.2rem 0.5rem !important;
  }
  
  /* Tarjetas de subasta y productos */
  .auction-card, .product-card {
    flex-direction: column !important;
    padding: 0.75rem !important;
  }
  
  .auction-card img,
  .product-card img {
    width: 100% !important;
    height: 180px !important;
    object-fit: cover;
  }
  
  /* Menú móvil inferior */
  .mobile-menu-item {
    padding: 0.4rem !important;
    font-size: 0.7rem !important;
    min-width: 50px !important;
    min-height: 50px !important;
  }
  
  .mobile-menu-item i {
    font-size: 1.3rem !important;
  }
}

/* Para pantallas muy pequeñas */
@media (max-width: 480px) {
  .header-title {
    font-size: 0.9rem !important;
  }
  
  #authButtonsContainer {
    gap: 0.25rem !important;
  }
  
  #authButtonsContainer button span {
    display: none !important;
  }
  
  #authButtonsContainer button {
    min-width: 40px !important;
    padding: 0.5rem 0.3rem !important;
  }
  
  .price-tag {
    font-size: 1.1rem !important;
  }
}
    
    input, select, textarea {
      background: rgba(26, 26, 46, 0.7) !important;
      border: 1px solid rgba(255, 255, 255, 0.15) !important;
      color: var(--text) !important;
      transition: all 0.3s ease;
    }
    select option {
  background: var(--dark-light);
  color: var(--text);
  padding: 0.5rem;
}

select option:hover {
  background: rgba(255, 62, 127, 0.2);
}
    
    input:focus, select:focus, textarea:focus {
      border-color: var(--primary) !important;
      box-shadow: 0 0 0 3px rgba(255, 62, 127, 0.3) !important;
      outline: none;
    }
    
    input::placeholder, textarea::placeholder {
      color: var(--text-light) !important;
    }
    
    .stats-card {
      background: linear-gradient(135deg, rgba(255, 62, 127, 0.15), rgba(255, 157, 0, 0.15));
      border-radius: 0.75rem;
      padding: 1rem;
      text-align: center;
      transition: transform 0.3s ease;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .stats-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(255, 62, 127, 0.3);
    }
    
    .stats-value {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 0.25rem;
    }
    
    .stats-label {
      font-size: 0.75rem;
      color: var(--text-light);
    }
    
    .confetti {
      position: fixed;
      width: 10px;
      height: 10px;
      background-color: #f00;
      opacity: 0;
      z-index: 1000;
      pointer-events: none;
    }
    
    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    
    .gradient-animate {
      background: linear-gradient(-45deg, var(--primary), var(--secondary), var(--accent), var(--success));
      background-size: 400% 400%;
      animation: gradientShift 8s ease infinite;
    }
    
    .section-transition {
      transition: all 0.5s ease;
    }
    
    .glow {
      box-shadow: 0 0 15px rgba(255, 62, 127, 0.6);
    }
    
    .glow:hover {
      box-shadow: 0 0 25px rgba(255, 62, 127, 0.8);
    }
    /* Validación de formularios */
    .form-control:invalid:not(:placeholder-shown) {
      border-color: var(--danger) !important;
    }

    .form-control:valid:not(:placeholder-shown) {
      border-color: var(--success) !important;
    }

    .form-check-input:checked {
      background-color: var(--primary);
      border-color: var(--primary);
    }

    .form-check-label a {
      text-decoration: none;
      transition: color 0.2s;
    }

    .form-check-label a:hover {
      color: var(--primary-dark);
    }
    
    .header-glow {
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
    }
    /* Header mejorado */
.animate-header {
  animation: slideDown 0.6s ease-out;
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.logo-container {
  position: relative;
  width: 70px;
  height: 70px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.logo-img-enhanced {
  width: 70px;
  height: 70px;
  border-radius: 16px;
  object-fit: contain;
  background: linear-gradient(135deg, rgba(255, 62, 127, 0.15), rgba(255, 157, 0, 0.15));
  padding: 8px;
  box-shadow: 
    0 8px 32px rgba(255, 62, 127, 0.4),
    0 0 0 2px rgba(255, 255, 255, 0.1);
  animation: logoFloat 3s ease-in-out infinite;
  position: relative;
  z-index: 2;
  transition: all 0.3s ease;
}

.logo-img-enhanced:hover {
  transform: scale(1.05) rotate(5deg);
  box-shadow: 
    0 12px 48px rgba(255, 62, 127, 0.6),
    0 0 0 3px rgba(255, 255, 255, 0.2);
}

@keyframes logoFloat {
  0%, 100% {
    transform: translateY(0);
  }
  50% {
    transform: translateY(-5px);
  }
}

.logo-ring {
  position: absolute;
  inset: -5px;
  border-radius: 20px;
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  opacity: 0.3;
  animation: ringPulse 2s ease-in-out infinite;
  z-index: 1;
}

@keyframes ringPulse {
  0%, 100% {
    transform: scale(1);
    opacity: 0.3;
  }
  50% {
    transform: scale(1.1);
    opacity: 0.1;
  }
}

.header-title {
  font-size: 1.75rem;
  font-weight: 900;
  background: linear-gradient(135deg, #ff3e7f 0%, #ff9d00 50%, #00d4ff 100%);
  background-size: 200% 200%;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  animation: gradientFlow 4s ease infinite;
  letter-spacing: -0.5px;
  text-shadow: 0 0 30px rgba(255, 62, 127, 0.3);
  line-height: 1.1;
}

/* Versión móvil del título */
@media (max-width: 767px) {
  .header-title {
    font-size: 1.4rem !important;
    line-height: 1 !important;
    letter-spacing: -0.3px;
  }
}

@keyframes gradientFlow {
  0%, 100% {
    background-position: 0% 50%;
  }
  50% {
    background-position: 100% 50%;
  }
}

.header-subtitle {
  font-size: 0.875rem;
  color: var(--text-light);
  font-weight: 500;
  margin-top: 2px;
  letter-spacing: 0.3px;
}

.tech-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  font-size: 0.7rem;
  font-weight: 600;
  padding: 4px 10px;
  border-radius: 20px;
  background: rgba(255, 62, 127, 0.15);
  border: 1px solid rgba(255, 62, 127, 0.3);
  color: var(--primary);
  transition: all 0.3s ease;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.tech-badge:hover {
  background: rgba(255, 62, 127, 0.25);
  border-color: rgba(255, 62, 127, 0.5);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(255, 62, 127, 0.3);
}

.tech-badge i {
  font-size: 0.8rem;
}

/* Mejora para botones del header */
header .btn {
  font-weight: 600;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

header .btn::after {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 0;
  height: 0;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.2);
  transform: translate(-50%, -50%);
  transition: width 0.6s, height 0.6s;
}

header .btn:hover::after {
  width: 300px;
  height: 300px;
}

/* Responsive mejorado */
@media (max-width: 768px) {
  .header-title {
    font-size: 1.35rem;
  }
  
  .header-subtitle {
    font-size: 0.75rem;
  }
  
  .tech-badge {
    font-size: 0.65rem;
    padding: 3px 8px;
  }
  
  .logo-container {
    width: 80px;
    height: 80px;
  }
  
  .logo-img-enhanced {
    width: 80px;
    height: 80px;
    border-radius: 16px;
    padding: 10px;
  }
}
    
    .bid-history {
      display: flex;
      align-items: center;
      margin-top: 10px;
    }
    
    .bidder-avatar {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      color: white;
      margin-right: -8px;
      border: 2px solid var(--dark);
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    
    .more-bidders {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--text-light);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      color: var(--dark);
      margin-right: 5px;
      border: 2px solid var(--dark);
    }
    
    .image-upload-container {
      border: 2px dashed rgba(255, 255, 255, 0.2);
      border-radius: 10px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      touch-action: manipulation;
    }
    
    .image-upload-container:hover {
      border-color: var(--primary);
      background: rgba(255, 62, 127, 0.05);
    }
    
    .image-upload-container.dragover {
      border-color: var(--success);
      background: rgba(0, 255, 136, 0.05);
    }
    
    .image-preview {
      max-width: 100%;
      max-height: 200px;
      border-radius: 8px;
      margin-top: 10px;
    }
    
    .increment-buttons {
      display: flex;
      gap: 5px;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    
    .increment-btn {
      flex: 1;
      min-width: 60px;
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 5px;
      color: var(--text);
      cursor: pointer;
      transition: all 0.2s ease;
      touch-action: manipulation;
      font-size: 0.875rem;
    }
    
    .increment-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }
    
    .increment-btn:active {
      transform: scale(0.95);
    }
    
    .increment-btn.active {
      background: var(--primary);
      border-color: var(--primary);
    }
    
    .quick-bid-btn {
      background: rgba(255, 157, 0, 0.2);
      border: 1px solid rgba(255, 157, 0, 0.5);
      color: var(--secondary);
    }
    
    .quick-bid-btn:hover {
      background: rgba(255, 157, 0, 0.3);
    }
    
    .bot-badge {
      background: rgba(0, 212, 255, 0.2);
      color: var(--accent);
      font-size: 0.7rem;
      padding: 2px 6px;
      border-radius: 10px;
      margin-left: 5px;
    }
    /* Animación para actualizaciones en tiempo real */
@keyframes pulse-highlight {
  0% { 
    transform: scale(1); 
    box-shadow: 0 0 0 0 rgba(34, 211, 238, 0.7);
  }
  50% {
    transform: scale(1.02);
    box-shadow: 0 0 20px 10px rgba(34, 211, 238, 0);
  }
  100% { 
    transform: scale(1);
    box-shadow: 0 0 0 0 rgba(34, 211, 238, 0);
  }
}

.pulse-highlight {
  animation: pulse-highlight 1s ease-out;
  border: 2px solid rgba(34, 211, 238, 0.5) !important;
}

/* Indicador de actualización en vivo */
.live-indicator {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 4px 10px;
  background: rgba(0, 255, 136, 0.2);
  border-radius: 12px;
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  box-shadow: 0 0 10px rgba(0, 255, 136, 0.3);
  color: var(--success);
}

.live-dot {
  width: 8px;
  height: 8px;
  background: #00ff88;
  border-radius: 50%;
  animation: live-pulse 2s infinite;
  box-shadow: 0 0 5px rgba(0, 255, 136, 0.6);
}

.live-dot {
  width: 8px;
  height: 8px;
  background: #ef4444;
  border-radius: 50%;
  animation: live-pulse 2s infinite;
}

@keyframes live-pulse {
  0%, 100% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.5; transform: scale(1.2); }
}

    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1050;
      max-width: 350px;
    }

    .toast {
      background: var(--dark-light);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: var(--text);
      margin-bottom: 10px;
      border-radius: 8px;
    }

    .toast-success {
      border-left: 4px solid var(--success);
    }

    .toast-error {
      border-left: 4px solid var(--danger);
    }

    .toast-info {
      border-left: 4px solid var(--accent);
    }

    .cart-badge {
      position: absolute;
      top: -8px;
      right: -8px;
      background: var(--danger);
      color: white;
      border-radius: 50%;
      min-width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: bold;
      padding: 0 4px;
    }

    .cart-item {
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      padding: 0.75rem 0;
    }

    .cart-item:last-child {
      border-bottom: none;
    }

    .quantity-controls {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .quantity-btn {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: var(--text);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      touch-action: manipulation;
    }

    .quantity-btn:hover {
      background: var(--primary);
      border-color: var(--primary);
    }

    .quantity-btn:active {
      transform: scale(0.9);
    }

    .quantity-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .quantity-btn:disabled:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.2);
    }

    .nav-tabs {
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }

    .nav-tabs .nav-link {
      background: transparent;
      border: none;
      color: var(--text-light);
      transition: all 0.3s ease;
    }

    .nav-tabs .nav-link:hover {
      color: var(--text);
      background: rgba(255, 255, 255, 0.05);
    }

    .nav-tabs .nav-link.active {
      color: var(--primary);
      background: rgba(255, 62, 127, 0.1);
      border-bottom: 2px solid var(--primary);
    }

    .payment-method {
      background: rgba(255, 255, 255, 0.1);
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      padding: 1rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      touch-action: manipulation;
    }

    .payment-method:hover {
      border-color: var(--primary);
      background: rgba(255, 62, 127, 0.1);
    }

    .payment-method:active {
      transform: scale(0.95);
    }

    .payment-method.selected {
      border-color: var(--primary);
      background: rgba(255, 62, 127, 0.2);
      box-shadow: 0 0 15px rgba(255, 62, 127, 0.4);
    }

    .spinner {
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top: 3px solid var(--primary);
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .bot-name-edit {
      background: transparent !important;
      border: none !important;
      color: var(--text) !important;
      font-size: 0.875rem;
      padding: 4px 8px;
      width: 100%;
      border-radius: 4px;
    }

    .bot-name-edit:focus {
      outline: 1px solid var(--primary);
      background: rgba(255, 255, 255, 0.05) !important;
      padding: 4px 8px;
    }
    
    .bot-settings-row {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 0.75rem;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      margin-bottom: 0.5rem;
    }
    .bot-toggle-switch {
  display: flex;
  align-items: center;
  gap: 10px;
  cursor: pointer;
  user-select: none;
}

.bot-toggle-slider {
  position: relative;
  width: 50px;
  height: 26px;
  background: rgba(255, 56, 96, 0.3);
  border-radius: 50px;
  transition: all 0.3s ease;
  border: 2px solid rgba(255, 56, 96, 0.5);
}

.bot-toggle-slider.active {
  background: rgba(0, 255, 136, 0.3);
  border-color: rgba(0, 255, 136, 0.8);
}

.bot-toggle-knob {
  position: absolute;
  top: 2px;
  left: 2px;
  width: 18px;
  height: 18px;
  background: #ff3860;
  border-radius: 50%;
  transition: all 0.3s ease;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
}

.bot-toggle-slider.active .bot-toggle-knob {
  left: 26px;
  background: #00ff88;
}

.bot-toggle-label {
  font-size: 0.75rem;
  font-weight: 600;
  min-width: 60px;
  color: var(--text-light);
}

.bot-toggle-switch:hover .bot-toggle-slider {
  box-shadow: 0 0 10px rgba(255, 62, 127, 0.5);
}

.bot-toggle-switch:active .bot-toggle-slider {
  transform: scale(0.95);
}
    
    .bot-settings-row label {
      font-size: 0.875rem;
      color: var(--text-light);
      margin-bottom: 0;
      min-width: 120px;
    }
    
    .bot-settings-row input[type="number"] {
      flex: 1;
      max-width: 120px;
      padding: 0.5rem;
      border-radius: 6px;
    }
    
    #globalLoader {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      backdrop-filter: blur(5px);
    }
    
    @media (max-width: 640px) {
      .toast-container {
        right: 10px;
        left: 10px;
        max-width: none;
      }
      
      .modal-dialog {
        margin: 1rem;
      }
      
      .increment-buttons {
        flex-wrap: wrap;
      }
      
      .increment-btn {
        min-width: calc(50% - 5px);
      }
    }
    /* Botones de autenticación apilados */
#authButtons {
  min-width: 140px;
}

#authButtons button {
  width: 100%;
  font-size: 0.875rem;
}

@media (max-width: 768px) {
  #authButtons {
    min-width: 44px;
  }
  
  #authButtons button span {
    display: none !important;
  }
  
  #authButtons {
    gap: 0.5rem;
  }
}
/* Panel de Administrador Mejorado */
.admin-stats-card {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 16px;
  padding: 20px;
  border-left: 4px solid var(--primary);
  transition: all 0.3s ease;
}

.admin-stats-card:hover {
  background: rgba(255, 255, 255, 0.08);
  transform: translateY(-5px);
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
}

.admin-stats-card.success {
  border-left-color: var(--success);
}

.admin-stats-card.warning {
  border-left-color: var(--warning);
}

.admin-stats-card.danger {
  border-left-color: var(--danger);
}

.stat-number {
  font-size: 2.5rem;
  font-weight: bold;
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.admin-table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0 10px;
}

.admin-table thead th {
  background: rgba(255, 255, 255, 0.05);
  padding: 12px;
  text-align: left;
  font-weight: 600;
  text-transform: uppercase;
  font-size: 0.75rem;
  color: var(--text-light);
  border-bottom: 2px solid rgba(255, 255, 255, 0.1);
}

.admin-table tbody tr {
  background: rgba(255, 255, 255, 0.03);
  transition: all 0.3s ease;
}

.admin-table tbody tr:hover {
  background: rgba(255, 255, 255, 0.08);
  transform: scale(1.01);
}

.admin-table tbody td {
  padding: 15px 12px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.05);
}

.admin-table tbody tr:first-child td:first-child {
  border-top-left-radius: 12px;
}

.admin-table tbody tr:first-child td:last-child {
  border-top-right-radius: 12px;
}

.admin-table tbody tr:last-child td:first-child {
  border-bottom-left-radius: 12px;
}

.admin-table tbody tr:last-child td:last-child {
  border-bottom-right-radius: 12px;
}

.status-badge {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
}

.status-badge.pending {
  background: rgba(255, 204, 0, 0.2);
  color: var(--warning);
}

.status-badge.paid {
  background: rgba(0, 255, 136, 0.2);
  color: var(--success);
}

.status-badge.expired {
  background: rgba(255, 56, 96, 0.2);
  color: var(--danger);
}

.status-badge.cancelled {
  background: rgba(148, 163, 184, 0.2);
  color: var(--text-light);
}

.admin-action-btn {
  padding: 6px 12px;
  border-radius: 8px;
  font-size: 0.85rem;
  border: none;
  cursor: pointer;
  transition: all 0.3s ease;
}

.admin-action-btn:hover {
  transform: scale(1.05);
}

.admin-tabs {
  display: flex;
  gap: 10px;
  margin-bottom: 20px;
  border-bottom: 2px solid rgba(255, 255, 255, 0.1);
}

.admin-tab {
  padding: 12px 24px;
  background: transparent;
  border: none;
  color: var(--text-light);
  cursor: pointer;
  transition: all 0.3s ease;
  border-bottom: 3px solid transparent;
  font-weight: 500;
}

.admin-tab:hover {
  color: white;
  background: rgba(255, 255, 255, 0.05);
}

.admin-tab.active {
  color: var(--primary);
  border-bottom-color: var(--primary);
}

.filter-chips {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  margin-bottom: 20px;
}

.filter-chip {
  padding: 6px 16px;
  border-radius: 20px;
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: var(--text-light);
  cursor: pointer;
  transition: all 0.3s ease;
  font-size: 0.85rem;
}

.filter-chip:hover {
  background: rgba(255, 255, 255, 0.15);
  border-color: rgba(255, 255, 255, 0.3);
}

.filter-chip.active {
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  border-color: var(--primary);
  color: white;
  font-weight: 600;
}

.item-thumbnail {
  width: 50px;
  height: 50px;
  border-radius: 8px;
  object-fit: cover;
}

.user-info {
  display: flex;
  align-items: center;
  gap: 10px;
}

.user-avatar {
  width: 35px;
  height: 35px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  font-size: 0.85rem;
}
.inbox-badge {
  position: absolute;
  top: -8px;
  right: -8px;
  background: var(--danger);
  color: white;
  border-radius: 50%;
  min-width: 20px;
  height: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.7rem;
  font-weight: bold;
  padding: 0 4px;
  animation: pulse-notification 2s infinite;
}

@keyframes pulse-notification {
  0%, 100% {
    transform: scale(1);
    box-shadow: 0 0 0 0 rgba(255, 56, 96, 0.7);
  }
  50% {
    transform: scale(1.1);
    box-shadow: 0 0 0 10px rgba(255, 56, 96, 0);
  }
}

.notification-card {
  background: rgba(255, 255, 255, 0.05);
  border-left: 4px solid var(--primary);
  transition: all 0.3s ease;
  cursor: pointer;
}

.notification-card:hover {
  background: rgba(255, 255, 255, 0.08);
  transform: translateX(5px);
}

.notification-card.unread {
  background: rgba(255, 62, 127, 0.1);
  border-left-color: var(--danger);
}

.notification-card.expired {
  opacity: 0.6;
  border-left-color: var(--text-light);
}

.payment-timer {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  padding: 4px 10px;
  background: rgba(255, 204, 0, 0.2);
  border-radius: 20px;
  font-size: 0.85rem;
  font-weight: 600;
}

.payment-timer.urgent {
  background: rgba(255, 56, 96, 0.2);
  color: var(--danger);
  animation: pulse-urgent 1s infinite;
}

@keyframes pulse-urgent {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.7; }
}

.payment-status {
  display: inline-block;
  padding: 4px 12px;
  border-radius: 12px;
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
}

.payment-status.pending {
  background: rgba(255, 204, 0, 0.2);
  color: var(--warning);
}

.payment-status.paid {
  background: rgba(0, 255, 136, 0.2);
  color: var(--success);
}

.payment-status.expired {
  background: rgba(255, 56, 96, 0.2);
  color: var(--danger);
}

.notification-icon {
  width: 50px;
  height: 50px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.5rem;
  flex-shrink: 0;
}

.notification-icon.auction {
  background: linear-gradient(135deg, var(--primary), var(--secondary));
}

.notification-icon.purchase {
  background: linear-gradient(135deg, var(--accent), var(--success));
}
/* Estilos para registro multi-paso */
.step-circle {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.1);
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  margin-bottom: 8px;
  transition: all 0.3s ease;
}

.step-circle.active {
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  box-shadow: 0 5px 15px rgba(255, 62, 127, 0.5);
}

.step-line {
  height: 2px;
  flex: 1;
  background: rgba(255, 255, 255, 0.1);
  margin: 0 10px;
  align-self: center;
}

.register-step {
  animation: fadeInStep 0.4s ease;
}

@keyframes fadeInStep {
  from {
    opacity: 0;
    transform: translateX(20px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}
/* Botones de autenticación apilados */
#authButtonsContainer {
  display: flex;
  flex-direction: column;
  gap: 0.375rem;
}

#authButtonsContainer button {
  white-space: nowrap;
  font-size: 0.875rem;
  font-weight: 500;
}

@media (max-width: 768px) {
  #authButtonsContainer button {
    min-width: 44px !important;
    padding: 0.5rem !important;
  }
  
  #authButtonsContainer button span {
    display: none;
  }
  
  #authButtonsContainer button i {
    margin: 0;
  }
}

  /* ✅ AGREGAR JUSTO AQUÍ - ANTES DE </style> */
  /* Correcciones de visualización */
  .admin-tab-content {
    display: none;
  }

  .admin-tab-content:first-child {
    display: block;
  }

  .status-badge.status-active {
    background: rgba(0, 255, 136, 0.2);
    color: var(--success);
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
  }

  .status-badge.status-ended {
    background: rgba(255, 56, 96, 0.2);
    color: var(--danger);
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
  }

  /* Mejoras responsive */
  @media (max-width: 768px) {
    .admin-tabs {
      flex-wrap: wrap;
      gap: 5px;
    }
    
    .admin-tab {
      padding: 8px 12px;
      font-size: 0.8rem;
    }
  }

  </style>
</head><body class="text-slate-100 pb-16 md:pb-0">
  <div id="particles-js"></div>
  
  <div class="toast-container" id="toastContainer"></div>
  
  <div class="max-w-6xl mx-auto p-4 relative z-10">
    <header class="flex items-center justify-between gap-2 mb-6 glass p-3 md:p-4 rounded-2xl header-glow animate-header">
  <!-- LADO IZQUIERDO: Logo + Título -->
  <div class="flex items-center gap-2 md:gap-4 flex-shrink min-w-0">
    <div class="logo-container flex-shrink-0">
      <img src="https://firebasestorage.googleapis.com/v0/b/subasta-argenta-474019.firebasestorage.app/o/imagenes%20utiles%2Flogo3.png?alt=media&token=bc5bab5c-0ccd-49e0-932b-2cee25a93b7d" alt="Subasta Argenta" class="logo-img-enhanced">
      <div class="logo-ring"></div>
    </div>
    <div class="min-w-0 flex-1">
      <h1 class="header-title text-base md:text-xl lg:text-2xl">
        <span class="hidden md:inline">Subasta Argenta</span>
        <span class="md:hidden block leading-tight">
          <span class="block">Subasta</span>
          <span class="block">Argenta</span>
        </span>
      </h1>
      <div class="header-subtitle hidden sm:block">Subastas en vivo y tienda virtual</div>
      <div class="hidden md:flex flex-wrap gap-2 mt-2">
        <span class="tech-badge"><i class="fas fa-fire"></i> TIENDA</span>
        <span class="tech-badge"><i class="fas fa-bolt"></i> SUBASTAS</span>
        <span class="tech-badge"><i class="fas fa-credit-card"></i> MERCADOPAGO</span>
      </div>
    </div>
  </div>
  
  <!-- LADO DERECHO: Botones de usuario -->
  <div class="flex items-center gap-2 flex-shrink-0">
    <div class="relative" id="inboxContainer" style="display:none">
  <button id="inboxBtn" class="btn btn-outline-light btn-sm flex items-center gap-1">
    <i class="fas fa-inbox"></i> <span class="hidden md:inline">Bandeja</span>
  </button>
  <span id="inboxBadge" class="inbox-badge hidden">0</span>
</div>
    <div class="relative" id="cartContainer" style="display:none">
      <button id="cartBtn" class="btn btn-outline-light btn-sm flex items-center gap-1 glow">
        <i class="fas fa-shopping-cart"></i> <span class="hidden md:inline">Carrito</span>
      </button>
      <span id="cartBadge" class="cart-badge hidden">0</span>
    </div>
    <button id="profileBtn" class="btn btn-outline-light btn-sm flex items-center gap-1" style="display:none">
      <i class="fas fa-user"></i> <span class="hidden lg:inline">Perfil</span>
    </button>
    <div id="userInfo" class="text-xs md:text-sm text-slate-300 hidden lg:block" style="display:none"></div>
    
    <!-- Contenedor de botones de autenticación -->
    <div id="authButtonsContainer" class="flex flex-col gap-1.5">
      <button id="loginBtn" class="btn btn-outline-light btn-sm flex items-center justify-center gap-1 glow whitespace-nowrap" style="min-width: 44px; padding: 0.4rem 0.6rem;">
        <i class="fas fa-sign-in-alt"></i> <span class="hidden sm:inline">Iniciar sesión</span>
      </button>
      <button id="registerBtn" class="btn btn-primary btn-sm flex items-center justify-center gap-1 whitespace-nowrap" style="min-width: 44px; padding: 0.4rem 0.6rem;">
        <i class="fas fa-user-plus"></i> <span class="hidden sm:inline">Regístrate</span>
      </button>
    </div>
    
    <button id="logoutBtn" class="btn btn-light btn-sm flex items-center gap-1" style="display:none">
      <i class="fas fa-sign-out-alt"></i> <span class="hidden lg:inline">Cerrar sesión</span>
    </button>
  </div>
</header>



    <div class="grid lg:grid-cols-3 gap-6">
      <main class="lg:col-span-2 space-y-6">
        <!-- PANEL DE ADMINISTRADOR MEJORADO -->
<section id="adminPanel" style="display:none">
  <div class="container mx-auto px-4 py-8">
    <!-- Header del Admin -->
    <div class="mb-6">
  <div class="d-flex justify-content-between align-items-center">
    <div>
      <h2 class="text-3xl font-bold mb-2">

    <button class="btn btn-outline-light" onclick="hideAdminPanel()">
      <i class="fas fa-arrow-left"></i> Volver
    </button>
  </div>
</div>
        <i class="fas fa-crown text-warning"></i> Panel de Administración
      </h2>
      <p class="text-slate-400">Gestión completa de subastas, productos y pagos</p>
    </div>

    <!-- Tabs de Navegación -->
    <div class="admin-tabs">
      <button class="admin-tab active" onclick="switchAdminTab('dashboard')">
        <i class="fas fa-chart-line"></i> Dashboard
      </button>
      <button class="admin-tab" onclick="switchAdminTab('auctions')">
        <i class="fas fa-gavel"></i> Subastas
      </button>
      <button class="admin-tab" onclick="switchAdminTab('products')">
        <i class="fas fa-box"></i> Productos
      </button>
      <button class="admin-tab" onclick="switchAdminTab('won-auctions')">
        <i class="fas fa-trophy"></i> Subastas Ganadas
      </button>
      <button class="admin-tab" onclick="switchAdminTab('purchases')">
        <i class="fas fa-shopping-cart"></i> Compras
      </button>
      <button class="admin-tab" onclick="switchAdminTab('users')">
        <i class="fas fa-users"></i> Usuarios
      </button>
      <button class="admin-tab" onclick="switchAdminTab('bots')">
        <i class="fas fa-robot"></i> Bots
      </button>
    </div>

    <!-- TAB: DASHBOARD -->
    <div id="adminTabDashboard" class="admin-tab-content">
      <!-- Estadísticas Generales -->
      <div class="row mb-4">
        <div class="col-md-3 mb-3">
          <div class="admin-stats-card">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <div>
                <div class="text-slate-400 text-sm mb-1">Subastas Activas</div>
                <div class="stat-number" id="statActiveAuctions">0</div>
              </div>
              <i class="fas fa-gavel fa-2x text-primary opacity-50"></i>
            </div>
          </div>
        </div>
        <div class="col-md-3 mb-3">
          <div class="admin-stats-card success">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <div>
                <div class="text-slate-400 text-sm mb-1">Pagos Completados</div>
                <div class="stat-number text-success" id="statPaidOrders">0</div>
              </div>
              <i class="fas fa-check-circle fa-2x text-success opacity-50"></i>
            </div>
            <div class="text-sm text-slate-300">$<span id="statPaidAmount">0</span> recaudado</div>
          </div>
        </div>
        <div class="col-md-3 mb-3">
          <div class="admin-stats-card warning">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <div>
                <div class="text-slate-400 text-sm mb-1">Pagos Pendientes</div>
                <div class="stat-number text-warning" id="statPendingOrders">0</div>
              </div>
              <i class="fas fa-clock fa-2x text-warning opacity-50"></i>
            </div>
            <div class="text-sm text-slate-300">$<span id="statPendingAmount">0</span> esperando</div>
          </div>
        </div>
        <div class="col-md-3 mb-3">
          <div class="admin-stats-card danger">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <div>
                <div class="text-slate-400 text-sm mb-1">Pagos Expirados</div>
                <div class="stat-number text-danger" id="statExpiredOrders">0</div>
              </div>
              <i class="fas fa-times-circle fa-2x text-danger opacity-50"></i>
            </div>
            <div class="text-sm text-slate-300">$<span id="statExpiredAmount">0</span> perdidos</div>
          </div>
        </div>
      </div>

      <!-- Gráfico de Actividad Reciente -->
      <div class="glass p-4 rounded-2xl mb-4">
        <h5 class="font-bold mb-3">
          <i class="fas fa-chart-bar text-blue-400"></i> Actividad Reciente
        </h5>
        <div id="recentActivityList"></div>
      </div>
    </div>

    <!-- TAB: SUBASTAS GANADAS -->
    <div id="adminTabWonAuctions" class="admin-tab-content" style="display:none">
      <div class="glass p-4 rounded-2xl">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="font-bold mb-0">
            <i class="fas fa-trophy text-warning"></i> Subastas Ganadas
          </h5>
          <button class="btn btn-sm btn-outline-light" onclick="refreshAdminData()">
            <i class="fas fa-sync-alt"></i> Actualizar
          </button>
        </div>

        <!-- Filtros -->
        <div class="filter-chips">
          <div class="filter-chip active" data-filter="all" onclick="filterWonAuctions('all')">
            Todas
          </div>
          <div class="filter-chip" data-filter="pending" onclick="filterWonAuctions('pending')">
            Pendientes
          </div>
          <div class="filter-chip" data-filter="paid" onclick="filterWonAuctions('paid')">
            Pagadas
          </div>
          <div class="filter-chip" data-filter="expired" onclick="filterWonAuctions('expired')">
            Expiradas
          </div>
        </div>

        <div style="overflow-x: auto;">
          <table class="admin-table">
            <thead>
              <tr>
                <th>Item</th>
                <th>Ganador</th>
                <th>Monto</th>
                <th>Fecha</th>
                <th>Expira</th>
                <th>Estado</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="wonAuctionsTableBody">
              <tr>
                <td colspan="7" class="text-center text-slate-400">Cargando...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- TAB: COMPRAS -->
    <div id="adminTabPurchases" class="admin-tab-content" style="display:none">
      <div class="glass p-4 rounded-2xl">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="font-bold mb-0">
            <i class="fas fa-shopping-cart text-blue-400"></i> Compras Realizadas
          </h5>
          <button class="btn btn-sm btn-outline-light" onclick="refreshAdminData()">
            <i class="fas fa-sync-alt"></i> Actualizar
          </button>
        </div>

        <!-- Filtros -->
        <div class="filter-chips">
          <div class="filter-chip active" data-filter="all" onclick="filterPurchases('all')">
            Todas
          </div>
          <div class="filter-chip" data-filter="pending" onclick="filterPurchases('pending')">
            Pendientes
          </div>
          <div class="filter-chip" data-filter="paid" onclick="filterPurchases('paid')">
            Pagadas
          </div>
          <div class="filter-chip" data-filter="expired" onclick="filterPurchases('expired')">
            Expiradas
          </div>
        </div>

        <div style="overflow-x: auto;">
          <table class="admin-table">
            <thead>
              <tr>
                <th>Item</th>
                <th>Usuario</th>
                <th>Cantidad</th>
                <th>Monto</th>
                <th>Fecha</th>
                <th>Expira</th>
                <th>Estado</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="purchasesTableBody">
              <tr>
                <td colspan="8" class="text-center text-slate-400">Cargando...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- TAB: SUBASTAS (existente mejorado) -->
    <div id="adminTabAuctions" class="admin-tab-content" style="display:none">
      <div class="glass p-4 rounded-2xl mb-4">
        <h5 class="font-bold mb-3">
          <i class="fas fa-plus-circle text-success"></i> Crear Nueva Subasta
        </h5>
        <form id="createAuctionForm" class="row g-3">
          <div class="col-md-6">
            <label class="text-xs text-slate-400 mb-1">Título</label>
            <input type="text" class="form-control bg-transparent text-light border-slate-700 rounded-xl" 
                   id="auctionTitle" required>
          </div>
          <div class="col-md-6">
            <label class="text-xs text-slate-400 mb-1">Precio Inicial ($)</label>
            <input type="number" class="form-control bg-transparent text-light border-slate-700 rounded-xl" 
                   id="auctionStartPrice" required min="1">
          </div>
          <div class="col-md-4">
            <label class="text-xs text-slate-400 mb-1">Precio Compra Ya ($)</label>
            <input type="number" class="form-control bg-transparent text-light border-slate-700 rounded-xl" 
                   id="auctionBuyNow" min="1">
          </div>
          <div class="col-md-4">
            <label class="text-xs text-slate-400 mb-1">Duración (minutos)</label>
            <input type="number" class="form-control bg-transparent text-light border-slate-700 rounded-xl" 
                   id="auctionDuration" required min="1" value="5">
          </div>
          <div class="col-md-4">
            <label class="text-xs text-slate-400 mb-1">Categoría</label>
            <select class="form-control bg-transparent text-light border-slate-700 rounded-xl" 
                    id="auctionCategory" required>
              <option value="electronics">Electrónica</option>
              <option value="fashion">Moda</option>
              <option value="home">Hogar</option>
              <option value="sports">Deportes</option>
              <option value="collectibles">Coleccionables</option>
            </select>
          </div>
          <div class="col-12">
            <label class="text-xs text-slate-400 mb-1">Descripción</label>
            <textarea class="form-control bg-transparent text-light border-slate-700 rounded-xl" 
                      id="auctionDescription" rows="2" required></textarea>
          </div>
          <div class="col-12">
            <label class="text-xs text-slate-400 mb-1">Imagen (URL o subir archivo)</label>
            <div class="input-group">
              <input type="text" class="form-control bg-transparent text-light border-slate-700" 
                     id="auctionImageURL" placeholder="https://...">
              <input type="file" class="form-control bg-transparent text-light border-slate-700" 
                     id="auctionImageFile" accept="image/*">
            </div>
          </div>
          <div class="col-12">
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-plus-circle"></i> Crear Subasta
            </button>
          </div>
        </form>
      </div>

      <div class="glass p-4 rounded-2xl">
        <h5 class="font-bold mb-3">
          <i class="fas fa-list"></i> Subastas Existentes
        </h5>
        <div id="adminAuctionsList"></div>
      </div>
    </div>

    <!-- TAB: PRODUCTOS -->
    <div id="adminTabProducts" class="admin-tab-content" style="display:none">
      <div class="glass p-4 rounded-2xl mb-4">
        <h5 class="font-bold mb-3">
          <i class="fas fa-plus-circle text-success"></i> Agregar Nuevo Producto
        </h5>
        <form id="createProductForm" class="row g-3">
          <div class="col-md-6">
            <label class="text-xs text-slate-400 mb-1">Título</label>
            <input type="text" class="form-control bg-transparent text-light border-slate-700 rounded-xl" 
                   id="productTitle" required>
          </div>
          <div class="col-md-3">
            <label class="text-xs text-slate-400 mb-1">Precio ($)</label>
            <input type="number" class="form-control bg-transparent text-light border-slate-700 rounded-xl" 
                   id="productPrice" required min="1">
          </div>
          <div class="col-md-3">
            <label class="text-xs text-slate-400 mb-1">Stock</label>
            <input type="number" class="form-control bg-transparent text-light border-slate-700 rounded-xl" 
                   id="productStock" required min="0">
          </div>
          <div class="col-md-6">
            <label class="text-xs text-slate-400 mb-1">Categoría</label>
            <select class="form-control bg-transparent text-light border-slate-700 rounded-xl" 
                    id="productCategory" required>
              <option value="electronics">Electrónica</option>
              <option value="fashion">Moda</option>
              <option value="home">Hogar</option>
              <option value="sports">Deportes</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="text-xs text-slate-400 mb-1">Imagen (URL)</label>
            <input type="text" class="form-control bg-transparent text-light border-slate-700 rounded-xl" 
                   id="productImage" required placeholder="https://...">
          </div>
          <div class="col-12">
            <label class="text-xs text-slate-400 mb-1">Descripción</label>
            <textarea class="form-control bg-transparent text-light border-slate-700 rounded-xl" 
                      id="productDescription" rows="2" required></textarea>
          </div>
          <div class="col-12">
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-plus-circle"></i> Agregar Producto
            </button>
          </div>
        </form>
      </div>

      <div class="glass p-4 rounded-2xl">
        <h5 class="font-bold mb-3">
          <i class="fas fa-list"></i> Productos Existentes
        </h5>
        <div id="adminProductsList"></div>
      </div>
    </div>

    <!-- TAB: USUARIOS -->
    <div id="adminTabUsers" class="admin-tab-content" style="display:none">
      <div class="glass p-4 rounded-2xl">
        <h5 class="font-bold mb-3">
          <i class="fas fa-users text-blue-400"></i> Usuarios Registrados
        </h5>
        <div id="adminUsersList"></div>
      </div>
    </div>

    <!-- TAB: BOTS -->
    <div id="adminTabBots" class="admin-tab-content" style="display:none">
      <div class="glass p-4 rounded-2xl mb-4">
        <h5 class="font-bold mb-3">
          <i class="fas fa-robot text-purple-400"></i> Configuración de Bots
        </h5>
        <form id="botSettingsForm" class="row g-3">
          <div class="col-md-4">
            <label class="text-xs text-slate-400 mb-1">Habilitar Bots</label>
            <select class="form-control bg-transparent text-light border-slate-700 rounded-xl" 
                    id="botEnabled">
              <option value="true">Sí</option>
              <option value="false">No</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="text-xs text-slate-400 mb-1">Delay (segundos)</label>
            <input type="number" class="form-control bg-transparent text-light border-slate-700 rounded-xl" 
                   id="botDelay" min="1" max="10" value="2">
          </div>
          <div class="col-md-4">
            <label class="text-xs text-slate-400 mb-1">Probabilidad (%)</label>
            <input type="number" class="form-control bg-transparent text-light border-slate-700 rounded-xl" 
                   id="botProbability" min="0" max="100" value="70">
          </div>
          <div class="col-12">
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-save"></i> Guardar Configuración
            </button>
          </div>
        </form>
      </div>

      <div class="glass p-4 rounded-2xl">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="font-bold mb-0">
            <i class="fas fa-list"></i> Lista de Bots
          </h5>
          <button class="btn btn-sm btn-success" onclick="addBotUser()">
            <i class="fas fa-plus"></i> Agregar Bot
          </button>
        </div>
        <div id="adminBotsList"></div>
      </div>
    </div>

    
        <!-- Contenido Principal para todos los usuarios -->
        <div class="glass p-5 rounded-2xl fade-in">
          <ul class="nav nav-pills mb-4" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="auctions-tab" data-bs-toggle="pill" data-bs-target="#auctions" type="button" role="tab">
                <i class="fas fa-gavel mr-1"></i> Subastas
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="store-tab" data-bs-toggle="pill" data-bs-target="#store" type="button" role="tab">
                <i class="fas fa-store mr-1"></i> Tienda Virtual
              </button>
            </li>
          </ul>
          
          <div class="tab-content" id="mainTabContent">
            <div class="tab-pane fade" id="auctions" role="tabpanel">
              <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-4">
                <div>
                  <h2 class="text-lg font-bold flex items-center gap-2">
                    <i class="fas fa-hourglass-half text-pink-400"></i> Subastas Activas
                  </h2>
                  <div class="text-sm text-slate-400">Ofertas rápidas y compra directa</div>
                </div>
                <div class="flex gap-2 w-full md:w-auto">
                  <button id="btnCreateDemo" class="btn btn-outline-light btn-sm flex items-center gap-1 flex-1 md:flex-none glow">
                    <i class="fas fa-magic"></i> <span>Crear demo</span>
                  </button>
                  <button id="openAdmin" class="btn btn-primary btn-sm flex items-center gap-1 flex-1 md:flex-none" style="display:none">
                    <i class="fas fa-cog"></i> <span>Panel Admin</span>
                  </button>
                </div>
              </div>

              <div class="filter-content md:!block mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <label class="text-xs text-slate-400 flex items-center gap-1 mb-1">
                    <i class="fas fa-search"></i> Buscar
                  </label>
                  <input id="searchAuctions" class="w-full rounded-xl p-3 bg-transparent border border-slate-700 text-sm" placeholder="Buscar..." />
                </div>
                <div>
                  <label class="text-xs text-slate-400 flex items-center gap-1 mb-1">
                    <i class="fas fa-sort"></i> Ordenar
                  </label>
                  <select id="sortAuctions" class="w-full rounded-xl p-3 bg-transparent border border-slate-700 text-sm">
                    <option value="ending">Próximo a terminar</option>
                    <option value="highest">Mayor puja</option>
                    <option value="newest">Más reciente</option>
                  </select>
                </div>
                <div>
                  <label class="text-xs text-slate-400 flex items-center gap-1 mb-1">
                    <i class="fas fa-filter"></i> Estado
                  </label>
                  <select id="filterAuctionState" class="w-full rounded-xl p-3 bg-transparent border border-slate-700 text-sm">
                    <option value="all">Todas</option>
                    <option value="active">Activas</option>
                    <option value="ended">Finalizadas</option>
                  </select>
                </div>
              </div>

              <div id="auctionsList" class="mt-6 grid gap-4"></div>
            </div>

            <div class="tab-pane fade show active" id="store" role="tabpanel">
              <!-- Subasta Destacada -->
              <div id="featuredAuction" class="mb-6"></div>
              
              <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-4">
                <div>
                  <h2 class="text-lg font-bold flex items-center gap-2">
                    <i class="fas fa-store text-blue-400"></i> Tienda Virtual
                  </h2>
                  <div class="text-sm text-slate-400">Productos para compra inmediata</div>
                </div>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div>
                  <label class="text-xs text-slate-400 flex items-center gap-1 mb-1">
                    <i class="fas fa-search"></i> Buscar
                  </label>
                  <input id="searchProducts" class="w-full rounded-xl p-3 bg-transparent border border-slate-700 text-sm" placeholder="Buscar..." />
                </div>
                <div>
                  <label class="text-xs text-slate-400 flex items-center gap-1 mb-1">
                    <i class="fas fa-tags"></i> Categoría
                  </label>
                  <select id="filterProductCategory" class="w-full rounded-xl p-3 bg-transparent border border-slate-700 text-sm">
                    <option value="all">Todas</option>
                  </select>
                </div>
                <div>
                  <label class="text-xs text-slate-400 flex items-center gap-1 mb-1">
                    <i class="fas fa-sort"></i> Ordenar
                  </label>
                  <select id="sortProducts" class="w-full rounded-xl p-3 bg-transparent border border-slate-700 text-sm">
                    <option value="newest">Más recientes</option>
                    <option value="price-asc">Precio menor</option>
                    <option value="price-desc">Precio mayor</option>
                  </select>
                </div>
              </div>

              <div id="productsList" class="grid gap-4"></div>
            </div>
          </div>
        </div>
      </main>

      <aside class="space-y-6">
        <!-- Saldo del usuario -->
        <div class="glass p-5 rounded-2xl sticky top-4" id="balanceSection">
  <div class="flex justify-between items-center mb-4">
    <div>
      <div class="text-sm text-slate-400">Saldo</div>
      <div id="balance" class="text-2xl font-bold price-tag">$0</div>
    </div>
    <div id="balanceButtons">
      <button id="topup" class="btn btn-outline-light btn-sm glow" style="display: none;">
        <i class="fas fa-plus"></i> Cargar
      </button>
    </div>
  </div>
  <div class="mt-4 text-sm">
    <div class="mb-2 font-medium">💡 Cómo funciona tu saldo</div>
    <div class="space-y-2 text-xs text-slate-400">
      <div class="p-2 rounded bg-slate-800/30">
        <i class="fas fa-plus-circle text-success"></i> Las recargas se acreditan al instante
      </div>
      <div class="p-2 rounded bg-slate-800/30">
        <i class="fas fa-gavel text-pink-400"></i> Las pujas reservan fondos temporalmente
      </div>
      <div class="p-2 rounded bg-slate-800/30">
        <i class="fas fa-shopping-cart text-blue-400"></i> Las compras debitan inmediatamente
      </div>
    </div>
  </div>
  <button id="viewTransactions" class="btn btn-outline-light btn-sm w-full mt-3" style="display: none;">
    <i class="fas fa-history"></i> Historial
  </button>
</div>
        </div>

        <!-- Filtros -->
        <div class="glass p-5 rounded-2xl">
          <h4 class="font-semibold mb-4">Filtros</h4>
          <div class="space-y-4">
            <select id="filterCategory" class="w-full rounded-xl p-3 bg-transparent border border-slate-700 text-sm">
              <option value="all">Todas las categorías</option>
            </select>
            <select id="filterTime" class="w-full rounded-xl p-3 bg-transparent border border-slate-700 text-sm">
              <option value="all">Cualquier tiempo</option>
              <option value="short">< 10 min</option>
              <option value="1hour">< 1 hora</option>
            </select>
          </div>
        </div>
        
      </aside>
    </div>
  </div>

  <div class="mobile-menu md:hidden">
    <div class="mobile-menu-item active" data-target="auctions">
      <i class="fas fa-gavel"></i>
      <span>Subastas</span>
    </div>
    <div class="mobile-menu-item" data-target="store">
      <i class="fas fa-store"></i>
      <span>Tienda</span>
    </div>
    <div class="mobile-menu-item" data-target="cart">
      <i class="fas fa-shopping-cart"></i>
      <span>Carrito</span>
    </div>
  </div>

  <!-- MODALES -->
  <div class="modal fade" id="loginModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
      <div class="modal-content glass border-0 rounded-2xl">
        <div class="modal-header border-slate-700">
          <h5 class="modal-title"><i class="fas fa-sign-in-alt text-pink-400"></i> Login</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="loginForm">
            <div class="mb-3">
              <input type="email" class="form-control bg-transparent text-light border-slate-700 rounded-xl" id="loginEmail" value="user@demo.com" placeholder="Email">
            </div>
            <div class="mb-3">
              <input type="password" class="form-control bg-transparent text-light border-slate-700 rounded-xl" id="loginPassword" value="user123" placeholder="Contraseña">
            </div>
            <button type="submit" class="btn btn-primary w-100 rounded-xl mb-3">Entrar</button>
            <div class="text-center text-sm">
              <span class="text-slate-400">¿No tienes cuenta?</span>
              <a href="#" id="switchToRegister" class="text-pink-400 ms-1">Regístrate</a>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
  <!-- MODAL DE REGISTRO MEJORADO -->
<div class="modal fade" id="registerModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content glass border-0 rounded-2xl">
      <div class="modal-header border-slate-700">
        <h5 class="modal-title"><i class="fas fa-user-plus text-pink-400"></i> Crear Cuenta</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
        <form id="registerForm">
          <!-- Progress Steps -->
          <div class="mb-4">
            <div class="d-flex justify-content-between align-items-center">
              <div class="text-center flex-fill">
                <div class="step-circle active" id="step1-circle">1</div>
                <small class="text-slate-400">Datos Personales</small>
              </div>
              <div class="step-line"></div>
              <div class="text-center flex-fill">
                <div class="step-circle" id="step2-circle">2</div>
                <small class="text-slate-400">Dirección</small>
              </div>
              <div class="step-line"></div>
              <div class="text-center flex-fill">
                <div class="step-circle" id="step3-circle">3</div>
                <small class="text-slate-400">Confirmación</small>
              </div>
            </div>
          </div>

          <!-- PASO 1: Datos Personales -->
          <div id="registerStep1" class="register-step">
            <h6 class="mb-3 text-pink-400">Paso 1: Información Personal</h6>
            
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="text-xs text-slate-400 mb-1">Nombre completo *</label>
                <input type="text" class="form-control bg-transparent text-light border-slate-700 rounded-xl" 
                       id="registerName" placeholder="Juan Pérez" required minlength="3">
              </div>
              <div class="col-md-6 mb-3">
                <label class="text-xs text-slate-400 mb-1">DNI *</label>
                <input type="text" class="form-control bg-transparent text-light border-slate-700 rounded-xl" 
                       id="registerDNI" placeholder="12345678" required pattern="[0-9]{7,8}" maxlength="8">
              </div>
            </div>

            <div class="mb-3">
              <label class="text-xs text-slate-400 mb-1">Email *</label>
              <input type="email" class="form-control bg-transparent text-light border-slate-700 rounded-xl" 
                     id="registerEmail" placeholder="tu@email.com" required>
              <small class="text-slate-400 d-block mt-1">
                <i class="fas fa-info-circle"></i> Enviaremos un código de verificación
              </small>
            </div>

            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="text-xs text-slate-400 mb-1">Contraseña *</label>
                <input type="password" class="form-control bg-transparent text-light border-slate-700 rounded-xl" 
                       id="registerPassword" placeholder="Mínimo 6 caracteres" required minlength="6">
              </div>
              <div class="col-md-6 mb-3">
                <label class="text-xs text-slate-400 mb-1">Confirmar contraseña *</label>
                <input type="password" class="form-control bg-transparent text-light border-slate-700 rounded-xl" 
                       id="registerPasswordConfirm" placeholder="Repite tu contraseña" required minlength="6">
              </div>
            </div>

            <button type="button" class="btn btn-primary w-100" onclick="goToRegisterStep(2)">
              Siguiente <i class="fas fa-arrow-right ms-2"></i>
            </button>
          </div>

          <!-- PASO 2: Dirección de Envío -->
          <div id="registerStep2" class="register-step" style="display: none;">
            <h6 class="mb-3 text-pink-400">Paso 2: Dirección de Envío</h6>
            
            <div class="mb-3">
              <label class="text-xs text-slate-400 mb-1">Buscar dirección *</label>
              <input type="text" class="form-control bg-transparent text-light border-slate-700 rounded-xl" 
                     id="addressAutocomplete" placeholder="Escribe tu dirección...">
              <small class="text-slate-400 d-block mt-1">
                <i class="fas fa-map-marker-alt"></i> Escribe y selecciona de las sugerencias
              </small>
            </div>

            <div class="mb-3">
              <label class="text-xs text-slate-400 mb-1">Dirección completa *</label>
              <input type="text" class="form-control bg-transparent text-light border-slate-700 rounded-xl" 
                     id="registerAddress" placeholder="Calle 123" required readonly>
            </div>

            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="text-xs text-slate-400 mb-1">Localidad *</label>
                <input type="text" class="form-control bg-transparent text-light border-slate-700 rounded-xl" 
                       id="registerCity" placeholder="Buenos Aires" required readonly>
              </div>
              <div class="col-md-6 mb-3">
                <label class="text-xs text-slate-400 mb-1">Provincia *</label>
                <input type="text" class="form-control bg-transparent text-light border-slate-700 rounded-xl" 
                       id="registerProvince" placeholder="Buenos Aires" required readonly>
              </div>
            </div>

            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="text-xs text-slate-400 mb-1">Código Postal *</label>
                <input type="text" class="form-control bg-transparent text-light border-slate-700 rounded-xl" 
                       id="registerZipCode" placeholder="1234" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="text-xs text-slate-400 mb-1">Teléfono de contacto *</label>
                <input type="tel" class="form-control bg-transparent text-light border-slate-700 rounded-xl" 
                       id="registerPhone" placeholder="11 1234-5678" required>
              </div>
            </div>

            <div id="mapPreview" class="mb-3" style="height: 200px; border-radius: 12px; overflow: hidden; display: none;">
              <!-- Mapa de Google Maps -->
            </div>

            <div class="d-flex gap-2">
              <button type="button" class="btn btn-outline-light flex-fill" onclick="goToRegisterStep(1)">
                <i class="fas fa-arrow-left me-2"></i> Atrás
              </button>
              <button type="button" class="btn btn-primary flex-fill" onclick="goToRegisterStep(3)">
                Siguiente <i class="fas fa-arrow-right ms-2"></i>
              </button>
            </div>
          </div>

          <!-- PASO 3: Confirmación -->
          <div id="registerStep3" class="register-step" style="display: none;">
            <h6 class="mb-3 text-pink-400">Paso 3: Confirmar Datos</h6>
            
            <div class="glass-light p-3 rounded-xl mb-3">
              <h6 class="font-bold mb-2"><i class="fas fa-user text-blue-400"></i> Datos Personales</h6>
              <div class="text-sm text-slate-300">
                <div><strong>Nombre:</strong> <span id="confirmName"></span></div>
                <div><strong>DNI:</strong> <span id="confirmDNI"></span></div>
                <div><strong>Email:</strong> <span id="confirmEmail"></span></div>
              </div>
            </div>

            <div class="glass-light p-3 rounded-xl mb-3">
              <h6 class="font-bold mb-2"><i class="fas fa-map-marker-alt text-pink-400"></i> Dirección</h6>
              <div class="text-sm text-slate-300">
                <div id="confirmFullAddress"></div>
                <div><strong>Teléfono:</strong> <span id="confirmPhone"></span></div>
              </div>
            </div>

            <div class="mb-3 form-check">
              <input type="checkbox" class="form-check-input" id="registerTerms" required>
              <label class="form-check-label text-xs" for="registerTerms">
                Acepto los <a href="#" class="text-pink-400" id="openTermsLink2">términos y condiciones</a>
              </label>
            </div>

            <div class="d-flex gap-2">
              <button type="button" class="btn btn-outline-light flex-fill" onclick="goToRegisterStep(2)">
                <i class="fas fa-arrow-left me-2"></i> Atrás
              </button>
              <button type="submit" class="btn btn-primary flex-fill">
                <i class="fas fa-check-circle me-2"></i> Crear Cuenta
              </button>
            </div>
          </div>

          <div class="text-center text-sm mt-3">
            <span class="text-slate-400">¿Ya tienes cuenta?</span>
            <a href="#" id="switchToLogin" class="text-pink-400 ms-1">Inicia sesión</a>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>


  <div class="modal fade" id="bidModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content glass border-0 rounded-2xl">
        <div class="modal-header border-slate-700">
          <h5 class="modal-title"><i class="fas fa-gavel text-pink-400"></i> Ofertar</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="bidAuctionInfo" class="mb-4"></div>
          <form id="bidForm">
            <input type="hidden" id="bidAuctionId">
            <input type="number" step="500" min="500" class="form-control bg-transparent text-light border-slate-700 rounded-xl mb-3" id="bidAmount" placeholder="Tu puja" required>
            <button type="submit" class="btn btn-primary w-100 rounded-xl">Confirmar</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="cartModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content glass border-0 rounded-2xl">
        <div class="modal-header border-slate-700">
          <h5 class="modal-title"><i class="fas fa-shopping-cart text-blue-400"></i> Carrito</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="cartItems" class="space-y-3 mb-4"></div>
          <div id="cartEmpty" class="text-center py-4 text-slate-400 hidden">
            <i class="fas fa-shopping-cart fa-2x mb-3 opacity-50"></i>
            <div>Tu carrito está vacío</div>
          </div>
          <div id="cartSummary">
            <div class="flex justify-between mb-3">
              <span>Total:</span>
              <span id="cartTotal" class="price-tag">$0</span>
            </div>
            <button id="checkoutBtn" class="btn btn-primary w-100 rounded-xl mb-2">Pagar con Saldo</button>
            <button id="mercadopagoBtn" class="btn btn-outline-light w-100 rounded-xl">MercadoPago</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="topupModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content glass border-0 rounded-2xl">
        <div class="modal-header border-slate-700">
          <h5 class="modal-title"><i class="fas fa-wallet text-pink-400"></i> Recargar Saldo</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
  <div id="topupAmountSelection">
    <div class="alert alert-info text-center mb-4" style="background: rgba(0, 212, 255, 0.1); border: 1px solid rgba(0, 212, 255, 0.3); color: var(--accent);">
      <i class="fas fa-wallet"></i> Tu saldo actual: <strong class="price-tag" style="font-size: 1.2rem;">$<span id="currentBalanceInModal">0</span></strong>
    </div>
    
    <h6 class="mb-3 text-center">Selecciona el monto a recargar</h6>
    <div class="grid grid-cols-2 gap-3 mb-4">
      <button class="btn btn-outline-light topup-amount-btn" data-amount="500">
        <div>$500</div>
        <small class="text-slate-400">Básico</small>
      </button>
      <button class="btn btn-outline-light topup-amount-btn" data-amount="1000">
        <div>$1000</div>
        <small class="text-slate-400">Recomendado</small>
      </button>
      <button class="btn btn-outline-light topup-amount-btn" data-amount="2000">
        <div>$2000</div>
        <small class="text-slate-400">Plus</small>
      </button>
      <button class="btn btn-outline-light topup-amount-btn" data-amount="5000">
        <div>$5000</div>
        <small class="text-slate-400">Premium</small>
      </button>
    </div>
    <input type="number" id="customTopupAmount" class="form-control bg-transparent text-light border-slate-700 rounded-xl mb-3" placeholder="Otro monto (mínimo $100)" min="100">
    <button id="proceedToPayment" class="btn btn-primary w-100" disabled>
      <i class="fas fa-arrow-right"></i> Continuar con MercadoPago
    </button>
  </div>
  
  <div id="topupPaymentMethods" class="hidden">
    <h6 class="mb-3 text-center">Método de Pago</h6>
    <div class="d-flex justify-content-center mb-4">
      <div class="payment-method selected" data-method="mercadopago" style="max-width: 300px; width: 100%;">
        <i class="fab fa-cc-mastercard fa-3x mb-2 text-blue-400"></i>
        <div class="font-semibold text-lg">MercadoPago</div>
        <small class="text-slate-400 mt-2 d-block">Todas las tarjetas de crédito y débito</small>
        <div class="mt-2">
          <span class="badge bg-success me-1">Visa</span>
          <span class="badge bg-success me-1">Mastercard</span>
          <span class="badge bg-success">Amex</span>
        </div>
      </div>
    </div>
    <div class="alert alert-info text-center" style="background: rgba(0, 212, 255, 0.1); border: 1px solid rgba(0, 212, 255, 0.3); color: var(--accent);">
      <i class="fas fa-info-circle"></i> Serás redirigido a MercadoPago para completar el pago de forma segura
    </div>
    <button id="confirmTopupPayment" class="btn btn-primary w-100 btn-lg">
      <i class="fas fa-lock"></i> Pagar con MercadoPago
    </button>
  </div>
  
  <div id="topupLoading" class="text-center py-4 hidden">
    <div class="spinner mb-3"></div>
    <div>Procesando pago...</div>
    <small class="text-slate-400">Por favor espera</small>
  </div>
  
  <div id="topupSuccess" class="text-center py-4 hidden">
    <i class="fas fa-check-circle fa-3x mb-3" style="color: var(--success);"></i>
    <h4 style="color: var(--success);">¡Éxito!</h4>
    <div id="topupDetails"></div>
  </div>
</div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="mpModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content glass border-0 rounded-2xl">
        <div class="modal-header border-slate-700">
          <h5 class="modal-title"><i class="fas fa-credit-card text-blue-400"></i> MercadoPago</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="paymentSummary" class="mb-4">
            <h6 class="mb-3">Resumen</h6>
            <div id="paymentItems"></div>
            <div class="border-top pt-3 mt-3">
              <div class="flex justify-between">
                <span>Total:</span>
                <span id="paymentTotal" class="price-tag">$0</span>
              </div>
            </div>
          </div>
          <div id="paymentMethods">
            <div class="grid grid-cols-2 gap-3">
              <div class="payment-method" data-method="credit_card">
                <i class="fas fa-credit-card fa-2x mb-2"></i>
                <div>Crédito</div>
              </div>
              <div class="payment-method" data-method="debit_card">
                <i class="fas fa-money-check fa-2x mb-2"></i>
                <div>Débito</div>
              </div>
            </div>
          </div>
          <div id="paymentLoading" class="text-center py-4 hidden">
            <div class="spinner mb-3"></div>
            <div>Procesando...</div>
          </div>
          <div id="paymentSuccess" class="text-center py-4 hidden">
            <i class="fas fa-check-circle fa-3x mb-3" style="color: var(--success);"></i>
            <h4 style="color: var(--success);">¡Pago exitoso!</h4>
            <div id="paymentDetails"></div>
          </div>
          <div id="paymentActions" class="mt-4 flex gap-2">
            <button id="confirmPayment" class="btn btn-primary flex-1" disabled>Pagar</button>
            <button id="cancelPayment" class="btn btn-outline-light">Cancelar</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- MODAL DE TÉRMINOS Y CONDICIONES -->
<div class="modal fade" id="termsModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content glass border-0 rounded-2xl">
      <div class="modal-header border-slate-700">
        <h5 class="modal-title">
          <i class="fas fa-file-contract text-pink-400"></i> Términos y Condiciones
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
        <div class="space-y-4 text-sm">
          
          <div>
            <h6 class="font-bold text-pink-400 mb-2">1. Aceptación de los Términos</h6>
            <p class="text-slate-300">
              Al acceder y utilizar Subasta Argenta, usted acepta estar sujeto a estos términos y condiciones. 
              Si no está de acuerdo con alguna parte de estos términos, no debe utilizar nuestro servicio.
            </p>
          </div>

          <div>
            <h6 class="font-bold text-pink-400 mb-2">2. Descripción del Servicio</h6>
            <p class="text-slate-300">
              Subasta Argenta es una plataforma de subastas en línea y tienda virtual que permite a los usuarios:
            </p>
            <ul class="list-disc ml-5 text-slate-300 mt-2 space-y-1">
              <li>Participar en subastas públicas</li>
              <li>Realizar ofertas en tiempo real</li>
              <li>Comprar productos directamente</li>
              <li>Gestionar su saldo y transacciones</li>
            </ul>
          </div>

          <div>
            <h6 class="font-bold text-pink-400 mb-2">3. Registro y Cuenta de Usuario</h6>
            <p class="text-slate-300 mb-2">
              Para utilizar nuestros servicios, debe:
            </p>
            <ul class="list-disc ml-5 text-slate-300 space-y-1">
              <li>Proporcionar información veraz y actualizada</li>
              <li>Mantener la confidencialidad de su contraseña</li>
              <li>Ser mayor de 18 años</li>
              <li>No compartir su cuenta con terceros</li>
              <li>Notificar cualquier uso no autorizado de su cuenta</li>
            </ul>
          </div>

          <div>
            <h6 class="font-bold text-pink-400 mb-2">4. Reglas de las Subastas</h6>
            <p class="text-slate-300 mb-2"><strong>4.1 Ofertas:</strong></p>
            <ul class="list-disc ml-5 text-slate-300 space-y-1 mb-2">
              <li>Todas las ofertas son vinculantes y no pueden ser retiradas</li>
              <li>Los incrementos mínimos son de $500 ARS</li>
              <li>Debe tener saldo suficiente para realizar una oferta</li>
              <li>La oferta más alta al finalizar el tiempo gana la subasta</li>
            </ul>
            <p class="text-slate-300 mb-2"><strong>4.2 Compra Directa:</strong></p>
            <ul class="list-disc ml-5 text-slate-300 space-y-1">
              <li>Algunos artículos incluyen opción de compra inmediata</li>
              <li>La compra directa finaliza la subasta instantáneamente</li>
              <li>El precio de compra directa se deduce inmediatamente del saldo</li>
            </ul>
          </div>

          <div>
            <h6 class="font-bold text-pink-400 mb-2">5. Pagos y Saldo</h6>
            <ul class="list-disc ml-5 text-slate-300 space-y-1">
              <li>Los pagos se procesan a través de MercadoPago</li>
              <li>El saldo se acredita inmediatamente tras el pago exitoso</li>
              <li>Los reembolsos se procesarán en un plazo de 5-10 días hábiles</li>
              <li>No se cobran comisiones por recarga de saldo</li>
              <li>Las transacciones fallidas no afectan su saldo</li>
            </ul>
          </div>

          <div>
            <h6 class="font-bold text-pink-400 mb-2">6. Tienda Virtual</h6>
            <p class="text-slate-300 mb-2">
              Los productos en la tienda virtual están sujetos a:
            </p>
            <ul class="list-disc ml-5 text-slate-300 space-y-1">
              <li>Disponibilidad de stock en tiempo real</li>
              <li>Precios fijos sin negociación</li>
              <li>Políticas de devolución según el tipo de producto</li>
              <li>Garantía del vendedor cuando aplique</li>
            </ul>
          </div>

          <div>
            <h6 class="font-bold text-pink-400 mb-2">7. Prohibiciones</h6>
            <p class="text-slate-300 mb-2">Está estrictamente prohibido:</p>
            <ul class="list-disc ml-5 text-slate-300 space-y-1">
              <li>Manipular subastas mediante múltiples cuentas</li>
              <li>Realizar ofertas sin intención de compra</li>
              <li>Vender artículos ilegales o robados</li>
              <li>Hacer uso fraudulento de métodos de pago</li>
              <li>Acosar o amenazar a otros usuarios</li>
              <li>Intentar vulnerar la seguridad de la plataforma</li>
            </ul>
          </div>

          <div>
            <h6 class="font-bold text-pink-400 mb-2">8. Comisiones y Tarifas</h6>
            <p class="text-slate-300">
              La plataforma cobra una comisión del 10% sobre el valor final de las subastas completadas. 
              Esta comisión cubre los costos operativos y de mantenimiento del servicio.
            </p>
          </div>

          <div>
            <h6 class="font-bold text-pink-400 mb-2">9. Privacidad y Datos Personales</h6>
            <p class="text-slate-300 mb-2">
              Sus datos personales son tratados conforme a nuestra Política de Privacidad:
            </p>
            <ul class="list-disc ml-5 text-slate-300 space-y-1">
              <li>Recopilamos solo información necesaria para el servicio</li>
              <li>No compartimos sus datos con terceros sin consentimiento</li>
              <li>Utilizamos encriptación para proteger información sensible</li>
              <li>Puede solicitar la eliminación de sus datos en cualquier momento</li>
            </ul>
          </div>

          <div>
            <h6 class="font-bold text-pink-400 mb-2">10. Responsabilidad</h6>
            <p class="text-slate-300 mb-2">
              Subasta Argenta actúa como intermediario entre compradores y vendedores. No nos hacemos responsables por:
            </p>
            <ul class="list-disc ml-5 text-slate-300 space-y-1">
              <li>La calidad o autenticidad de los productos</li>
              <li>Disputas entre usuarios</li>
              <li>Pérdidas económicas por decisiones de compra</li>
              <li>Interrupciones técnicas temporales del servicio</li>
            </ul>
          </div>

          <div>
            <h6 class="font-bold text-pink-400 mb-2">11. Suspensión y Cancelación</h6>
            <p class="text-slate-300">
              Nos reservamos el derecho de suspender o cancelar cuentas que:
            </p>
            <ul class="list-disc ml-5 text-slate-300 space-y-1">
              <li>Violen estos términos y condiciones</li>
              <li>Realicen actividades fraudulentas</li>
              <li>Reciban múltiples reportes de otros usuarios</li>
              <li>Presenten comportamiento abusivo o ilegal</li>
            </ul>
          </div>

          <div>
            <h6 class="font-bold text-pink-400 mb-2">12. Modificaciones</h6>
            <p class="text-slate-300">
              Subasta Argenta se reserva el derecho de modificar estos términos en cualquier momento. 
              Los cambios entrarán en vigor inmediatamente después de su publicación. 
              El uso continuado del servicio constituye aceptación de los términos modificados.
            </p>
          </div>

          <div>
            <h6 class="font-bold text-pink-400 mb-2">13. Jurisdicción</h6>
            <p class="text-slate-300">
              Estos términos se rigen por las leyes de la República Argentina. 
              Cualquier disputa será resuelta en los tribunales de Buenos Aires, Argentina.
            </p>
          </div>

          <div>
            <h6 class="font-bold text-pink-400 mb-2">14. Contacto</h6>
            <p class="text-slate-300">
              Para consultas sobre estos términos, puede contactarnos a través de:
            </p>
            <ul class="list-none ml-0 text-slate-300 space-y-1 mt-2">
              <li><i class="fas fa-envelope mr-2 text-pink-400"></i> soporte@subastaargenta.com</li>
              <li><i class="fas fa-phone mr-2 text-pink-400"></i> +54 11 1234-5678</li>
              <li><i class="fas fa-map-marker-alt mr-2 text-pink-400"></i> Buenos Aires, Argentina</li>
            </ul>
          </div>

          <div class="glass-light p-4 rounded-xl mt-4">
            <p class="text-center text-slate-300 mb-0">
              <i class="fas fa-info-circle text-blue-400 mr-2"></i>
              <strong>Última actualización:</strong> Octubre 2025
            </p>
          </div>

        </div>
      </div>
      <div class="modal-footer border-slate-700">
        <button type="button" class="btn btn-primary w-100" data-bs-dismiss="modal">
          <i class="fas fa-check"></i> Entendido
        </button>
      </div>
    </div>
  </div>
</div>
  <div class="modal fade" id="profileModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content glass border-0 rounded-2xl">
      <div class="modal-header border-slate-700">
        <h5 class="modal-title"><i class="fas fa-user text-pink-400"></i> Mi Perfil</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="profileForm">
          <div class="mb-3">
            <label class="text-sm text-slate-400 mb-1 block">Nombre</label>
            <input type="text" id="profileName" class="form-control bg-transparent text-light border-slate-700 rounded-xl" placeholder="Tu nombre" required>
          </div>
          <div class="mb-3">
            <label class="text-sm text-slate-400 mb-1 block">Email</label>
            <input type="email" id="profileEmail" class="form-control bg-transparent text-light border-slate-700 rounded-xl" readonly>
          </div>
          <button type="submit" class="btn btn-primary w-100 rounded-xl">Guardar Cambios</button>
        </form>
      </div>
    </div>
  </div>
</div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script><!-- Pega este código después del script de Bootstrap y antes de </body> -->

<script>
// ============================================
// SUBASTA ARGENTA - JAVASCRIPT COMPLETO
// ============================================

// CONFIGURACIÓN FIREBASE
const firebaseConfig = {
  apiKey: "AIzaSyD-Np6TWWMqjV85eOaM0zkRobPUJJ6uc-8",
  authDomain: "subasta-argenta-474019.firebaseapp.com",
  projectId: "subasta-argenta-474019",
  storageBucket: "subasta-argenta-474019.firebasestorage.app",
  messagingSenderId: "1002319635937",
  appId: "1:1002319635937:web:abc123"
};

let db, auth, storage;
try {
  firebase.initializeApp(firebaseConfig);
  db = firebase.firestore();
  auth = firebase.auth();
  storage = firebase.storage();
  console.log("✅ Firebase OK");
} catch (error) {
  console.error("❌ Firebase Error:", error);
  db = null;
  auth = null;
  storage = null;
}

// ESTADO GLOBAL
let state = {
  currentUser: null,
  auctions: [],
  products: [],
  bids: [],
  cart: [],
  orders: [],
  botUsers: [],
  botSettings: { enabled: true, delayGlobal: 2, probability: 70 },
  notifications: [], // ✨ NUEVO: Sistema de notificaciones
  currentIncrement: 500,
  imageUploaded: false,
  uploadedImageUrl: null
};


let selectedPaymentMethod = null;
let topupAmount = 0;
let countdownInterval = null;
let botActivityInterval = null;
// ID único para esta sesión
const SESSION_ID = 'session_' + Date.now() + '_' + Math.random();

// ==========================================
// SISTEMA DE SINCRONIZACIÓN EN TIEMPO REAL
// ==========================================

// Escuchar cambios de localStorage (sincronización entre pestañas)
window.addEventListener('storage', function(e) {
  if (e.key === 'auction_update' && e.newValue) {
    const update = JSON.parse(e.newValue);
    
    // Ignorar actualizaciones de esta misma sesión
    if (update.sessionId === SESSION_ID) return;
    
    handleRealtimeUpdate(update);
  }
});

// Polling cada 3 segundos para sincronización
setInterval(() => {
  checkForUpdates();
}, 3000);

function handleRealtimeUpdate(update) {
  switch(update.type) {
    case 'new_bid':
      handleNewBidUpdate(update.data);
      break;
    case 'auction_ended':
      handleAuctionEndedUpdate(update.data);
      break;
    case 'buy_now':
      handleBuyNowUpdate(update.data);
      break;
  }
}

function handleNewBidUpdate(data) {
  const auction = state.auctions.find(a => a.id === data.auctionId);
  if (!auction) return;
  
  // Actualizar la subasta
  auction.currentBid = data.amount;
  auction.lastBidTime = data.timestamp;
  
  // Agregar la puja si no existe
  if (!state.bids.find(b => b.id === data.bidId)) {
    state.bids.push({
      id: data.bidId,
      auctionId: data.auctionId,
      userId: data.userId,
      amount: data.amount,
      timestamp: data.timestamp
    });
  }
  
  // Actualizar UI
  renderAuctions();
  
  // Mostrar notificación SOLO A ADMINS si no es el usuario actual
  if (data.userId !== state.currentUser?.id && state.currentUser?.role === 'admin') {
    showToast(`🔔 Nueva puja en "${auction.title}": $${data.amount}`, 'info');
    highlightAuctionCard(data.auctionId);
  }
}

function handleAuctionEndedUpdate(data) {
  const auction = state.auctions.find(a => a.id === data.auctionId);
  if (auction) {
    auction.status = 'ended';
    renderAuctions();
    showToast(`⏱️ Subasta finalizada: "${auction.title}"`, 'warning');
  }
}

function handleBuyNowUpdate(data) {
  const auction = state.auctions.find(a => a.id === data.auctionId);
  if (auction) {
    auction.status = 'sold';
    renderAuctions();
    showToast(`✅ Compra inmediata en "${auction.title}"`, 'success');
  }
}

function highlightAuctionCard(auctionId) {
  const card = document.querySelector(`[data-auction-id="${auctionId}"]`);
  if (card) {
    card.classList.add('pulse-highlight');
    setTimeout(() => card.classList.remove('pulse-highlight'), 2000);
  }
}

function broadcastUpdate(type, data) {
  const update = {
    type: type,
    data: data,
    sessionId: SESSION_ID,
    timestamp: new Date().toISOString()
  };
  
  localStorage.setItem('auction_update', JSON.stringify(update));
}

function checkForUpdates() {
  const saved = localStorage.getItem('subastaArgenta_backup');
  if (saved) {
    const savedState = JSON.parse(saved);
    let hasChanges = false;
    
    savedState.auctions.forEach(savedAuction => {
      const currentAuction = state.auctions.find(a => a.id === savedAuction.id);
      if (currentAuction && savedAuction.currentBid !== currentAuction.currentBid) {
        currentAuction.currentBid = savedAuction.currentBid;
        currentAuction.lastBidTime = savedAuction.lastBidTime;
        hasChanges = true;
      }
    });
    
    if (hasChanges) {
      renderAuctions();
    }
  }
}

// ======================
// UTILIDADES
// ======================

function sanitizeHTML(str) {
  const temp = document.createElement('div');
  temp.textContent = str;
  return temp.innerHTML;
}

function debounce(func, wait) {
  let timeout;
  return (...args) => {
    clearTimeout(timeout);
    timeout = setTimeout(() => func(...args), wait);
  };
}

const rateLimiter = {
  attempts: {},
  limit: 5,
  window: 60000,
  check(action) {
    const now = Date.now();
    if (!this.attempts[action]) this.attempts[action] = [];
    this.attempts[action] = this.attempts[action].filter(t => now - t < this.window);
    if (this.attempts[action].length >= this.limit) return false;
    this.attempts[action].push(now);
    return true;
  }
};

function showLoading(msg = 'Cargando...') {
  if (document.getElementById('globalLoader')) return;
  const loader = document.createElement('div');
  loader.id = 'globalLoader';
  loader.innerHTML = `<div class="glass p-6 rounded-2xl text-center"><div class="spinner mb-3"></div><div>${sanitizeHTML(msg)}</div></div>`;
  document.body.appendChild(loader);
}

function hideLoading() {
  const loader = document.getElementById('globalLoader');
  if (loader) loader.remove();
}

function showToast(msg, type = 'info') {
  const container = document.getElementById('toastContainer');
  const toast = document.createElement('div');
  toast.className = `toast show toast-${type}`;
  toast.innerHTML = `<div class="toast-body d-flex justify-content-between align-items-center"><span>${sanitizeHTML(msg)}</span><button type="button" class="btn-close btn-close-white ms-2" onclick="this.parentElement.parentElement.remove()"></button></div>`;
  container.appendChild(toast);
  setTimeout(() => toast.remove(), 5000);
}

function handleError(error, context) {
  const messages = {
    'auth/user-not-found': 'Usuario no encontrado',
    'auth/wrong-password': 'Contraseña incorrecta',
    'auth/configuration-not-found': 'Configura Firebase Authentication primero',
    'permission-denied': 'Sin permisos'
  };
  const msg = messages[error.code] || `Error: ${error.message}`;
  showToast(msg, 'error');
  console.error(`[${context}]`, error);
}

function createConfetti() {
  const colors = ['#ff3e7f', '#ff9d00', '#00d4ff', '#00ff88'];
  for (let i = 0; i < 100; i++) {
    const c = document.createElement('div');
    c.className = 'confetti';
    c.style.left = Math.random() * 100 + 'vw';
    c.style.backgroundColor = colors[Math.floor(Math.random() * 4)];
    c.style.width = c.style.height = Math.random() * 10 + 5 + 'px';
    document.body.appendChild(c);
    c.animate([
      { transform: 'translateY(0) rotate(0)', opacity: 1 },
      { transform: `translateY(${window.innerHeight}px) rotate(${Math.random()*360}deg)`, opacity: 0 }
    ], { duration: Math.random() * 3000 + 2000, easing: 'ease-out' }).onfinish = () => c.remove();
  }
}

function formatTimeRemaining(endTime) {
  const diff = new Date(endTime) - new Date();
  if (diff <= 0) return 'Finalizada';
  const d = Math.floor(diff / 86400000);
  const h = Math.floor((diff % 86400000) / 3600000);
  const m = Math.floor((diff % 3600000) / 60000);
  if (d > 0) return `${d}d ${h}h`;
  if (h > 0) return `${h}h ${m}m`;
  return `${m}m`;
}

function getPaymentMethodName(method) {
  const names = {
    'credit_card': 'Tarjeta de Crédito',
    'debit_card': 'Tarjeta de Débito',
    'mercadopago': 'MercadoPago',
    'cash': 'Efectivo'
  };
  return names[method] || 'Método';
}

// ======================
// FIREBASE
// ======================

// ======================
// PERSISTENCIA DE SESIÓN
// ======================

function setupAuthListener() {
  if (!auth) {
    console.warn("⚠️ Auth no disponible");
    return;
  }
  
  auth.onAuthStateChanged(async (user) => {
    if (user) {
      // Usuario autenticado - restaurar sesión
      console.log("🔐 Sesión detectada:", user.email);
      
      try {
        // Obtener datos del usuario desde Firestore
        const userDoc = await db.collection('users').doc(user.uid).get();
        
        if (userDoc.exists) {
          state.currentUser = { 
            id: user.uid, 
            ...userDoc.data() 
          };
        } else {
          // Si no existe en Firestore, crear el documento
          state.currentUser = {
            id: user.uid,
            name: user.displayName || 'Usuario',
            email: user.email,
            balance: 5000,
            role: 'user'
          };
          await db.collection('users').doc(user.uid).set(state.currentUser);
        }
        
        console.log("✅ Sesión restaurada:", state.currentUser.name);
        updateUI();
        
        // Iniciar listener de tiempo real solo si hay usuario
        startRealtimeListener();
        
      } catch (error) {
        console.error("Error restaurando sesión:", error);
        handleError(error, 'Restaurar sesión');
      }
    } else {
      // No hay usuario autenticado
      console.log("🚪 Sin sesión activa");
      state.currentUser = null;
      stopRealtimeListener();
      updateUI();
    }
  });
}

let realtimeListener = null; // Variable global para el listener


async function loadState() {
  try {
    if (db) {
      const doc = await db.collection('appState').doc('mainState').get();
      if (doc.exists) {
        const data = doc.data();
        Object.assign(state, {
          auctions: data.auctions || [],
          products: data.products || [],
          bids: data.bids || [],
          cart: data.cart || [],
          orders: data.orders || [],
          botUsers: data.botUsers || [],
          botSettings: data.botSettings || state.botSettings
        });
        console.log("✅ Datos de Firebase cargados");
        
        // NO iniciar listener aquí - se iniciará en setupAuthListener
        return;
      }
    }
  } catch (e) {
    console.error("Error Firebase:", e);
  }
  
  const backup = localStorage.getItem('subastaArgenta_backup');
  if (backup) {
    Object.assign(state, JSON.parse(backup));
    console.log("✅ Datos del backup");
  } else {
    loadDemoData();
  }
}
async function saveState() {
  // Guardar en localStorage como backup
  localStorage.setItem('subastaArgenta_backup', JSON.stringify(state));
  
  // Guardar en Firestore si hay usuario y db disponible
  if (state.currentUser && db) {
    try {
      await db.collection('appState').doc('mainState').set({
        auctions: state.auctions,
        products: state.products,
        bids: state.bids,
        cart: state.cart,
        orders: state.orders,
        botUsers: state.botUsers,
        botSettings: state.botSettings,
        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
      });
      console.log("💾 Estado guardado en Firestore");
    } catch (e) {
      console.error("❌ Error guardando en Firestore:", e);
      showToast('Error al sincronizar', 'error');
    }
  }
}

function loadDemoData() {
  const now = new Date();
  state.botUsers = [
    { id: 101, name: 'Bot 1', balance: 8000, active: true, delay: 2 },
    { id: 102, name: 'Bot 2', balance: 7500, active: true, delay: 3 }
  ];
  state.auctions = [{
    id: 1,
    title: 'iPhone 14 Pro',
    description: 'Nuevo en caja',
    image: 'https://images.unsplash.com/photo-1592750475338-74b7b21085ab?w=500',
    category: 'Electrónicos',
    startPrice: 500,
    currentBid: 500,
    buyNowPrice: 1200,
    endTime: new Date(now.getTime() + 24*60*60*1000).toISOString(),
    sellerId: 2,
    bids: [],
    lastBidTime: now.toISOString(),
    status: 'active'
  }];
  state.products = [{
    id: 1,
    title: 'Laptop Gaming',
    description: 'Alto rendimiento',
    image: 'https://images.unsplash.com/photo-1593642702821-c8da6771f0c6?w=500',
    category: 'Electrónicos',
    price: 1200,
    stock: 5,
    featured: true
  }];
  saveState();
  console.log("✅ Demo data cargada");
}

function startRealtimeListener() {
  if (!db || !state.currentUser) {
    console.warn("⚠️ Firestore o usuario no disponible");
    if (!state.currentUser) {
      console.log("ℹ️ Esperando autenticación...");
    } else {
      startLocalPolling();
    }
    return;
  }
  
  if (realtimeListener) {
    console.log("⚠️ Listener ya activo");
    return;
  }
  
  console.log("🔴 Iniciando escucha en tiempo real...");
  
  try {
    // Escuchar cambios en tiempo real en Firestore
    realtimeListener = db.collection('appState').doc('mainState')
      .onSnapshot({
        includeMetadataChanges: false
      }, (doc) => {
        if (!doc.exists) {
          console.warn("⚠️ Documento no existe en Firestore");
          return;
        }
        
        const data = doc.data();
        const updatedAuctions = data.auctions || [];
        
        // Verificar si hay cambios en las subastas
        let hasChanges = false;
        let featuredNeedsUpdate = false;
        let dashboardNeedsUpdate = false;
        
        updatedAuctions.forEach(updatedAuction => {
          const currentAuction = state.auctions.find(a => a.id === updatedAuction.id);
          if (currentAuction) {
            // Detectar cambios en puja o estado
            if (currentAuction.currentBid !== updatedAuction.currentBid || 
                currentAuction.status !== updatedAuction.status ||
                currentAuction.lastBidTime !== updatedAuction.lastBidTime) {
              hasChanges = true;
              
              // Marcar que el dashboard necesita actualización
              dashboardNeedsUpdate = true;
              
              // Verificar si la subasta que cambió es activa
              if (updatedAuction.status === 'active') {
                featuredNeedsUpdate = true;
              }
              
              // Actualizar la subasta
              Object.assign(currentAuction, updatedAuction);
              
              // Animación visual de actualización
              highlightAuctionCard(updatedAuction.id);
              
              // Notificación solo para admins
              if (state.currentUser?.role === 'admin' && currentAuction.currentBid !== updatedAuction.currentBid) {
                showToast(`🔴 EN VIVO: Nueva puja $${updatedAuction.currentBid}`, 'info');
              }
            }
          }
        });
        
        // Actualizar dashboard si hay cambios relevantes
        if (dashboardNeedsUpdate && state.currentUser?.role === 'admin') {
          renderDashboardStats();
        }
        
        // Actualizar estado completo si hay cambios
        if (hasChanges) {
          state.auctions = updatedAuctions;
          state.bids = data.bids || [];
          
          // Renderizar vistas
          renderAuctions();
          renderFeaturedAuction();
          
          console.log("🔴 Actualización en tiempo real aplicada");
          
          // Animar tarjeta destacada si cambió
          if (featuredNeedsUpdate) {
            setTimeout(() => {
              const featuredCard = document.querySelector('#featuredAuction .glass-light');
              if (featuredCard) {
                featuredCard.classList.add('pulse-highlight');
                setTimeout(() => featuredCard.classList.remove('pulse-highlight'), 2000);
              }
            }, 100);
          }
        }
      }, (error) => {
        console.error("❌ Error en listener:", error);
        
        // Si falla, usar polling local como fallback
        if (error.code === 'permission-denied' || error.code === 'unavailable') {
          showToast('⚠️ Modo offline - actualizaciones limitadas', 'warning');
          stopRealtimeListener();
          startLocalPolling();
        }
      });
      
    console.log("✅ Listener de Firestore activo");
  } catch (error) {
    console.error("❌ Error iniciando listener:", error);
    startLocalPolling();
  }
}
// ======================
// SISTEMA DE POLLING LOCAL (FALLBACK)
// ======================

// ======================
// SISTEMA DE POLLING LOCAL (FALLBACK)
// ======================

let localPollingInterval = null;

function startLocalPolling() {
  if (localPollingInterval) return;
  
  console.log("🔄 Iniciando polling local (cada 5 segundos)");
  
  localPollingInterval = setInterval(async () => {
    if (!db) return;
    
    try {
      const doc = await db.collection('appState').doc('mainState').get();
      if (!doc.exists) return;
      
      const data = doc.data();
      const updatedAuctions = data.auctions || [];
      
      let hasChanges = false;
      updatedAuctions.forEach(updatedAuction => {
        const currentAuction = state.auctions.find(a => a.id === updatedAuction.id);
        if (currentAuction && currentAuction.currentBid !== updatedAuction.currentBid) {
          hasChanges = true;
          Object.assign(currentAuction, updatedAuction);
        }
      });
      
      if (hasChanges) {
        state.auctions = updatedAuctions;
        state.bids = data.bids || [];
        renderAuctions();
        renderFeaturedAuction();
        console.log("🔄 Actualización por polling");
      }
    } catch (error) {
      console.error("Error en polling:", error);
    }
  }, 5000); // Cada 5 segundos
}

function stopLocalPolling() {
  if (localPollingInterval) {
    clearInterval(localPollingInterval);
    localPollingInterval = null;
    console.log("⏸️ Polling local detenido");
  }
}

function stopRealtimeListener() {
  if (realtimeListener) {
    realtimeListener();
    realtimeListener = null;
    console.log("⏸️ Listener detenido");
  }
  stopLocalPolling();
}

// ======================
// UI Y RENDER
// ======================

function updateUI() {
  const userInfo = document.getElementById('userInfo');
  const authContainer = document.getElementById('authButtonsContainer');
  const logoutBtn = document.getElementById('logoutBtn');
  const profileBtn = document.getElementById('profileBtn');
  const cartBtn = document.getElementById('cartBtn');
  const inboxContainer = document.getElementById('inboxContainer');
  const balance = document.getElementById('balance');
  const adminPanel = document.getElementById('adminPanel');
  const openAdmin = document.getElementById('openAdmin');
  const topupBtn = document.getElementById('topup');
  const viewTransactionsBtn = document.getElementById('viewTransactions');
  const balanceSection = document.getElementById('balanceSection');
  
  // Verificar que los elementos existan antes de usarlos
  if (state.currentUser) {
    // USUARIO LOGUEADO
    if (userInfo) {
      userInfo.textContent = state.currentUser.name;
      userInfo.style.display = 'block';
    }
    if (authContainer) authContainer.style.display = 'none';
    if (logoutBtn) logoutBtn.style.display = 'block';
    if (profileBtn) profileBtn.style.display = 'block';
    if (cartBtn && cartBtn.parentElement) cartBtn.parentElement.style.display = 'block';
    if (inboxContainer) inboxContainer.style.display = 'block';
updateInboxUI();
    if (balance) balance.textContent = `$${state.currentUser.balance}`;
    if (topupBtn) topupBtn.style.display = 'block';
    if (viewTransactionsBtn) viewTransactionsBtn.style.display = 'block';
    if (balanceSection) balanceSection.style.display = 'block';
    
        if (state.currentUser?.role === 'admin') {
      const openAdminBtn = document.getElementById('openAdmin');
      if (openAdminBtn) {
        openAdminBtn.style.display = 'block';
        openAdminBtn.onclick = toggleAdminPanel;
      }
    } else {
      const openAdminBtn = document.getElementById('openAdmin');
      if (openAdminBtn) openAdminBtn.style.display = 'none';
      hideAdminPanel();
    }
    function hideAdminPanel() {
  const adminPanel = document.getElementById('adminPanel');
  const mainContent = document.querySelector('main');
  
  if (adminPanel) adminPanel.style.display = 'none';
  if (mainContent) mainContent.style.display = 'block';
}

  } else {
    // SIN SESIÓN
    if (userInfo) {
      userInfo.textContent = '';
      userInfo.style.display = 'none';
    }
    if (authContainer) authContainer.style.display = 'flex';
    if (logoutBtn) logoutBtn.style.display = 'none';
    if (profileBtn) profileBtn.style.display = 'none';
    if (cartBtn && cartBtn.parentElement) cartBtn.parentElement.style.display = 'none';
    if (inboxContainer) inboxContainer.style.display = 'none';
    if (balance) balance.textContent = '$0';
    if (openAdmin) openAdmin.style.display = 'none';
    if (adminPanel) adminPanel.classList.add('hidden');
    if (topupBtn) topupBtn.style.display = 'none';
    if (viewTransactionsBtn) viewTransactionsBtn.style.display = 'none';
    if (balanceSection) balanceSection.style.display = 'none';
  }
  
  updateCategoryFilter();
  updateCartUI();
}

function updateCategoryFilter() {
  const cats = [...new Set(state.auctions.map(a => a.category))];
  const filter = document.getElementById('filterCategory');
  if (filter) {
    filter.innerHTML = '<option value="all">Todas</option>' + cats.map(c => `<option value="${c}">${c}</option>`).join('');
  }
  const pCats = [...new Set(state.products.map(p => p.category))];
  const pFilter = document.getElementById('filterProductCategory');
  if (pFilter) {
    pFilter.innerHTML = '<option value="all">Todas</option>' + pCats.map(c => `<option value="${c}">${c}</option>`).join('');
  }
}

function renderAuctions(auctions = null) {
  const list = document.getElementById('auctionsList');
  const items = auctions || state.auctions;
  
  if (!items.length) {
    list.innerHTML = '<div class="text-center py-10 text-slate-400">No hay subastas</div>';
    return;
  }
  
  list.innerHTML = items.map(a => {
    // Obtener últimos 3 ofertantes únicos
    const recentBidders = a.bids.slice(-5).reverse()
      .map(userId => {
        const user = state.botUsers.find(b => b.id === userId);
        if (user) return { name: user.name, isBot: true };
        if (state.currentUser && state.currentUser.id === userId) {
          return { name: state.currentUser.name, isBot: false };
        }
        return { name: 'Usuario', isBot: false };
      })
      .filter((v, i, a) => a.findIndex(t => t.name === v.name) === i)
      .slice(0, 3);
    
    const biddersHTML = recentBidders.length > 0 ? `
      <div class="bid-history mt-2">
        <small class="text-slate-400 me-2">Ofertantes:</small>
        ${recentBidders.map(b => `
          <span class="bidder-avatar" title="${b.name}">
            ${b.name.charAt(0).toUpperCase()}
          </span>
        `).join('')}
        ${a.bids.length > 3 ? `<span class="more-bidders">+${a.bids.length - 3}</span>` : ''}
      </div>
    ` : '';
    
    return `
      <div class="auction-card glass p-4 rounded-xl" data-auction-id="${a.id}">
        <div class="flex flex-col sm:flex-row gap-4">
          ${a.status === 'active' ? '<div class="live-indicator mb-2"><span class="live-dot"></span>EN VIVO</div>' : ''}
          <img src="${a.image}" loading="lazy" alt="${sanitizeHTML(a.title)}" 
     class="w-full sm:w-24 h-24 object-cover rounded-lg" 
     style="cursor: pointer; transition: all 0.3s ease;" 
     onclick="event.stopPropagation(); showAuctionDetail(${a.id});"
     onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 5px 15px rgba(255,62,127,0.5)';"
     onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';">
          <div class="flex-grow">
            <div class="flex justify-between">
              <h3 class="font-semibold">${sanitizeHTML(a.title)}</h3>
              <span class="status-badge ${a.status === 'active' ? 'status-active' : 'status-ended'}">${a.status === 'active' ? 'Activa' : 'Finalizada'}</span>
            </div>
            <p class="text-sm text-slate-400 mt-1">${sanitizeHTML(a.description)}</p>
            ${biddersHTML}
            <div class="flex justify-between items-center mt-4">
              <div><div class="text-xs text-slate-400">Puja actual</div><div class="price-tag">$${a.currentBid || a.startPrice}</div></div>
              <div class="countdown" data-end="${a.endTime}">${formatTimeRemaining(a.endTime)}</div>
            </div>
            <div class="flex gap-2 mt-4">
  ${a.status === 'active' ? `
    <button class="bid-btn btn btn-primary btn-sm flex-1" data-id="${a.id}"><i class="fas fa-gavel"></i> Ofertar</button>
    ${a.buyNowPrice && a.buyNowPrice > (a.currentBid || a.startPrice) ? 
      `<button class="buynow-btn btn btn-outline-light btn-sm flex-1" data-id="${a.id}">Comprar ($${a.buyNowPrice})</button>` 
      : ''}
  ` : '<button class="btn btn-secondary btn-sm" disabled>Finalizada</button>'}
</div>
          </div>
        </div>
      </div>
    `;
  }).join('');
  
  document.querySelectorAll('.bid-btn').forEach(btn => {
    btn.onclick = () => openBidModal(parseInt(btn.dataset.id));
  });
  document.querySelectorAll('.buynow-btn').forEach(btn => {
    btn.onclick = () => buyNow(parseInt(btn.dataset.id));
  });
  
  startCountdown();
}
function renderFeaturedAuction() {
  const container = document.getElementById('featuredAuction');
  if (!container) return;
  
  const activeAuctions = state.auctions.filter(a => a.status === 'active');
  if (!activeAuctions.length) {
    container.innerHTML = '';
    return;
  }
  
  // Filtrar subastas que realmente estén activas (no expiradas)
  const now = new Date();
  const reallyActive = activeAuctions.filter(a => new Date(a.endTime) > now);
  
  if (!reallyActive.length) {
    container.innerHTML = '';
    
    // Marcar como finalizadas las que expiraron
    activeAuctions.forEach(a => {
      if (new Date(a.endTime) <= now) {
        a.status = 'ended';
      }
    });
    
    if (activeAuctions.length > 0) {
      saveState();
    }
    
    return;
  }
  
  reallyActive.sort((a, b) => new Date(a.endTime) - new Date(b.endTime));
  const featured = reallyActive[0];
  
  container.innerHTML = `
    <div class="glass-light p-3 md:p-4 rounded-2xl border-2 border-pink-500/30 mb-4">
      <div class="flex items-center justify-between mb-3">
        <h3 class="font-bold text-base md:text-lg">🔥 Subasta Destacada</h3>
        <a href="#" id="viewAllAuctions" class="text-xs md:text-sm text-pink-400 hover:text-pink-300 whitespace-nowrap">
          Ver todas →
        </a>
      </div>
      <div class="flex flex-col gap-3">
        <img src="${featured.image}" class="w-full h-40 md:h-48 object-cover rounded-xl" loading="lazy" alt="${sanitizeHTML(featured.title)}">
        <div>
          <h4 class="font-bold text-lg md:text-xl mb-3">${sanitizeHTML(featured.title)}</h4>
          <div class="grid grid-cols-2 gap-3 mb-3">
            <div class="glass-light p-3 rounded-xl text-center">
              <div class="text-xs text-slate-400 mb-1">Puja actual</div>
              <div class="featured-value">$${featured.currentBid || featured.startPrice}</div>
            </div>
            <div class="glass-light p-3 rounded-xl text-center">
              <div class="text-xs text-slate-400 mb-1">Termina en</div>
              <div class="featured-value">${formatTimeRemaining(featured.endTime)}</div>
            </div>
          </div>
          <button class="bid-btn btn btn-primary w-full" data-id="${featured.id}">
            <i class="fas fa-gavel"></i> Ofertar Ahora
          </button>
        </div>
      </div>
    </div>
  `;
  
  const bidBtn = container.querySelector('.bid-btn');
  if (bidBtn) bidBtn.onclick = () => openBidModal(parseInt(bidBtn.dataset.id));
  
  const viewAllLink = container.querySelector('#viewAllAuctions');
  if (viewAllLink) {
    viewAllLink.onclick = (e) => {
      e.preventDefault();
      document.getElementById('auctions-tab').click();
    };
  }
}

function renderProducts(products = null) {
  renderFeaturedAuction();
  
  const list = document.getElementById('productsList');
  const items = products || state.products;
  
  if (!items.length) {
    list.innerHTML = '<div class="text-center py-10 text-slate-400">No hay productos</div>';
    return;
  }
  
  list.innerHTML = items.map(p => `
    <div class="product-card glass p-4 rounded-xl">
      <div class="flex flex-col sm:flex-row gap-4">
        <!-- ✅ Solo la imagen abre el modal -->
        <img src="${p.image}" 
             loading="lazy" 
             alt="${sanitizeHTML(p.title)}" 
             class="w-full sm:w-24 h-24 object-cover rounded-lg"
             style="cursor: pointer; transition: transform 0.3s ease;"
             onclick="showProductDetail(${p.id})"
             onmouseover="this.style.transform='scale(1.05)'"
             onmouseout="this.style.transform='scale(1)'">
        
        <div class="flex-grow">
          <h3 class="font-semibold" style="cursor: pointer;" onclick="showProductDetail(${p.id})">${sanitizeHTML(p.title)}</h3>
          <p class="text-sm text-slate-400">${sanitizeHTML(p.description)}</p>
          <div class="flex justify-between items-center mt-4">
            <div class="price-tag">$${p.price}</div>
            <span class="text-xs">Stock: ${p.stock}</span>
          </div>
          ${p.stock > 0 ? `<button class="add-cart-btn btn btn-primary btn-sm w-full mt-3" data-id="${p.id}" onclick="event.stopPropagation();"><i class="fas fa-cart-plus"></i> Agregar</button>` : '<button class="btn btn-secondary btn-sm w-full mt-3" disabled>Agotado</button>'}
        </div>
      </div>
    </div>
  `).join('');
  
  document.querySelectorAll('.add-cart-btn').forEach(btn => {
    btn.onclick = () => addToCart(parseInt(btn.dataset.id));
  });
}

function startCountdown() {
  if (countdownInterval) clearInterval(countdownInterval);
  
  let secondCounter = 0;
  
  countdownInterval = setInterval(() => {
    // Actualizar contadores en todas las tarjetas
    document.querySelectorAll('.countdown').forEach(el => {
      el.textContent = formatTimeRemaining(el.dataset.end);
    });
    
    // Verificar subastas que expiraron
    state.auctions.forEach(auction => {
      if (auction.status === 'active') {
        const now = new Date();
        const endTime = new Date(auction.endTime);
        
        if (now >= endTime) {
          // Subasta finalizada
          auction.status = 'ended';
          
          // Si hubo pujas, determinar ganador
          if (auction.bids && auction.bids.length > 0) {
            const lastBidderId = auction.bids[auction.bids.length - 1];
            auction.winner = lastBidderId;
            auction.finalPrice = auction.currentBid;
            
            // Crear notificación para el ganador
            const winnerUser = state.botUsers.find(b => b.id === lastBidderId);
            const isRealUser = lastBidderId === state.currentUser?.id;
            
            if (isRealUser) {
              createNotification('auction_won', {
                itemId: auction.id,
                itemName: auction.title,
                itemImage: auction.image,
                amount: auction.currentBid,
                paymentStatus: 'pending'
              });
              
              showToast(`🏆 ¡Felicidades! Ganaste "${auction.title}"`, 'success');
            }
          }
          
          saveState();
          renderAuctions();
          renderFeaturedAuction();
        }
      }
    });
    
    // Cada 3 segundos, re-renderizar la subasta destacada
    secondCounter++;
    if (secondCounter >= 3) {
      secondCounter = 0;
      renderFeaturedAuction();
    }
  }, 1000);
}

// ======================
// AUTH
// ======================

function showLoginModal() {
  new bootstrap.Modal(document.getElementById('loginModal')).show();
}

async function handleLogin(e) {
  e.preventDefault();
  const email = document.getElementById('loginEmail').value;
  const password = document.getElementById('loginPassword').value;
  
  showLoading('Iniciando...');
  
  try {
    if (!auth) throw new Error('Firebase Auth no disponible');
    
    const cred = await auth.signInWithEmailAndPassword(email, password);
    const userDoc = await db.collection('users').doc(cred.user.uid).get();
    
    if (userDoc.exists) {
      state.currentUser = { id: cred.user.uid, ...userDoc.data() };
    } else {
      state.currentUser = {
        id: cred.user.uid,
        name: 'Usuario',
        email,
        balance: 5000,
        role: 'user'
      };
      await db.collection('users').doc(cred.user.uid).set(state.currentUser);
    }
    
    updateUI();
    bootstrap.Modal.getInstance(document.getElementById('loginModal')).hide();
    showToast(`👋 Bienvenido ${state.currentUser.name}`, 'success');
    
    // Iniciar listener después del login
    startRealtimeListener();
  } catch (error) {
    handleError(error, 'Login');
  } finally {
    hideLoading();
  }
}

async function logout() {
  try {
    if (auth) {
      await auth.signOut();
    }
    state.currentUser = null;
    stopRealtimeListener();
    updateUI();
    showToast('👋 Sesión cerrada', 'info');
  } catch (error) {
    handleError(error, 'Logout');
  }
}
// ======================
// REGISTRO DE USUARIOS
// ======================

// Variables globales para registro
let currentRegisterStep = 1;
let addressData = null;
let autocomplete = null;
let mapPreview = null;


function initAutocomplete() {
  const input = document.getElementById('addressAutocomplete');
  if (!input || typeof google === 'undefined' || !google.maps || !google.maps.places) {
    console.warn('⚠️ Google Maps Places no disponible');
    return;
  }

  try {
    autocomplete = new google.maps.places.Autocomplete(input, {
      componentRestrictions: { country: 'ar' },
      fields: ['address_components', 'geometry', 'formatted_address']
    });

    autocomplete.addListener('place_changed', onPlaceChanged);
    console.log('✅ Google Maps Autocomplete inicializado');
  } catch (error) {
    console.error('❌ Error inicializando Autocomplete:', error);
  }
}

function onPlaceChanged() {
  const place = autocomplete.getPlace();
  
  if (!place.geometry) {
    showToast('❌ Por favor selecciona una dirección de la lista', 'error');
    return;
  }

  // Extraer componentes de dirección
  let street = '';
  let city = '';
  let province = '';
  let zipCode = '';

  place.address_components.forEach(component => {
    const types = component.types;
    
    if (types.includes('route')) {
      street = component.long_name;
    }
    if (types.includes('street_number')) {
      street = component.long_name + ' ' + street;
    }
    if (types.includes('locality')) {
      city = component.long_name;
    }
    if (types.includes('administrative_area_level_1')) {
      province = component.long_name;
    }
    if (types.includes('postal_code')) {
      zipCode = component.long_name;
    }
  });

  // Rellenar campos
  document.getElementById('registerAddress').value = street || place.formatted_address;
  document.getElementById('registerCity').value = city;
  document.getElementById('registerProvince').value = province;
  document.getElementById('registerZipCode').value = zipCode;

  // Guardar datos
  addressData = {
    fullAddress: place.formatted_address,
    street: street,
    city: city,
    province: province,
    zipCode: zipCode,
    latitude: place.geometry.location.lat(),
    longitude: place.geometry.location.lng()
  };

  // Mostrar mapa
  showMapPreview(place.geometry.location);
  showToast('✅ Dirección validada correctamente', 'success');
}

function showMapPreview(location) {
  const mapDiv = document.getElementById('mapPreview');
  mapDiv.style.display = 'block';

  mapPreview = new google.maps.Map(mapDiv, {
    center: location,
    zoom: 16,
    disableDefaultUI: true
  });

  new google.maps.Marker({
    position: location,
    map: mapPreview,
    animation: google.maps.Animation.DROP
  });
}

// Navegación entre pasos del registro
function goToRegisterStep(step) {
  // Validar paso actual antes de avanzar
  if (step > currentRegisterStep) {
    if (currentRegisterStep === 1 && !validateRegisterStep1()) return;
    if (currentRegisterStep === 2 && !validateRegisterStep2()) return;
  }

  // Ocultar paso actual
  document.getElementById(`registerStep${currentRegisterStep}`).style.display = 'none';
  document.getElementById(`step${currentRegisterStep}-circle`).classList.remove('active');

  // Mostrar nuevo paso
  document.getElementById(`registerStep${step}`).style.display = 'block';
  document.getElementById(`step${step}-circle`).classList.add('active');

  // Si es paso 3, llenar confirmación
  if (step === 3) {
    fillConfirmationData();
  }

  currentRegisterStep = step;
}

function validateRegisterStep1() {
  const name = document.getElementById('registerName').value.trim();
  const dni = document.getElementById('registerDNI').value.trim();
  const email = document.getElementById('registerEmail').value.trim();
  const password = document.getElementById('registerPassword').value;
  const passwordConfirm = document.getElementById('registerPasswordConfirm').value;

  if (name.length < 3) {
    showToast('❌ El nombre debe tener al menos 3 caracteres', 'error');
    return false;
  }

  if (!/^[0-9]{7,8}$/.test(dni)) {
    showToast('❌ DNI inválido (debe tener 7 u 8 dígitos)', 'error');
    return false;
  }

  if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
    showToast('❌ Email inválido', 'error');
    return false;
  }

  if (password.length < 6) {
    showToast('❌ La contraseña debe tener al menos 6 caracteres', 'error');
    return false;
  }

  if (password !== passwordConfirm) {
    showToast('❌ Las contraseñas no coinciden', 'error');
    return false;
  }

  return true;
}

function validateRegisterStep2() {
  if (!addressData) {
    showToast('❌ Debes buscar y seleccionar tu dirección', 'error');
    return false;
  }

  const phone = document.getElementById('registerPhone').value.trim();
  const zipCode = document.getElementById('registerZipCode').value.trim();

  if (!phone) {
    showToast('❌ Ingresa un teléfono de contacto', 'error');
    return false;
  }

  if (!zipCode) {
    showToast('❌ Ingresa el código postal', 'error');
    return false;
  }

  return true;
}

function fillConfirmationData() {
  document.getElementById('confirmName').textContent = document.getElementById('registerName').value;
  document.getElementById('confirmDNI').textContent = document.getElementById('registerDNI').value;
  document.getElementById('confirmEmail').textContent = document.getElementById('registerEmail').value;
  document.getElementById('confirmPhone').textContent = document.getElementById('registerPhone').value;
  
  const fullAddress = `${addressData.fullAddress}, ${document.getElementById('registerCity').value}, ${document.getElementById('registerProvince').value} (CP: ${document.getElementById('registerZipCode').value})`;
  document.getElementById('confirmFullAddress').textContent = fullAddress;
}
function showRegisterModal() {
  // Cerrar modal de login si está abierto
  const loginModal = bootstrap.Modal.getInstance(document.getElementById('loginModal'));
  if (loginModal) loginModal.hide();
  
  // Abrir modal de registro
  new bootstrap.Modal(document.getElementById('registerModal')).show();
}

async function handleRegister(e) {
  e.preventDefault();
  
  const name = document.getElementById('registerName').value.trim();
  const dni = document.getElementById('registerDNI').value.trim();
  const email = document.getElementById('registerEmail').value.trim();
  const password = document.getElementById('registerPassword').value;
  const phone = document.getElementById('registerPhone').value.trim();
  const termsAccepted = document.getElementById('registerTerms').checked;
  
  if (!termsAccepted) {
    showToast('❌ Debes aceptar los términos y condiciones', 'error');
    return;
  }

  if (!addressData) {
    showToast('❌ Error en los datos de dirección', 'error');
    goToRegisterStep(2);
    return;
  }
  
  showLoading('Creando cuenta...');
  
  try {
    if (!auth) throw new Error('Firebase Auth no disponible');
    
    // Crear usuario en Firebase Auth
    const cred = await auth.createUserWithEmailAndPassword(email, password);
    
    // Actualizar perfil con nombre
    await cred.user.updateProfile({
      displayName: name
    });
    
    // Crear documento completo de usuario en Firestore
    const userData = {
      id: cred.user.uid,
      name: name,
      dni: dni,
      email: email,
      phone: phone,
      address: {
        fullAddress: addressData.fullAddress,
        street: addressData.street,
        city: addressData.city,
        province: addressData.province,
        zipCode: document.getElementById('registerZipCode').value,
        latitude: addressData.latitude,
        longitude: addressData.longitude
      },
      balance: 0,
      role: 'user',
      createdAt: new Date().toISOString(),
      totalBids: 0,
      totalPurchases: 0,
      emailVerified: false
    };
    
    await db.collection('users').doc(cred.user.uid).set(userData);
    await cred.user.sendEmailVerification();
    
    state.currentUser = userData;
    
    bootstrap.Modal.getInstance(document.getElementById('registerModal')).hide();
    document.getElementById('registerForm').reset();
    currentRegisterStep = 1;
    addressData = null;
    
    updateUI();
    createConfetti();
    showToast(`🎉 ¡Bienvenido ${name}! Revisa tu email para verificar tu cuenta`, 'success');
    
    startRealtimeListener();
    
  } catch (error) {
    const messages = {
      'auth/email-already-in-use': 'Este email ya está registrado',
      'auth/invalid-email': 'Email inválido',
      'auth/operation-not-allowed': 'Registro no habilitado',
      'auth/weak-password': 'Contraseña muy débil',
      'auth/network-request-failed': 'Error de conexión'
    };
    const msg = messages[error.code] || `Error: ${error.message}`;
    showToast(msg, 'error');
    console.error('[Registro]', error);
  } finally {
    hideLoading();
  }
}

// Aquí debe continuar con la siguiente función (switchToLogin, etc.)

function switchToLogin() {
  const registerModal = bootstrap.Modal.getInstance(document.getElementById('registerModal'));
  if (registerModal) registerModal.hide();
  
  setTimeout(() => {
    new bootstrap.Modal(document.getElementById('loginModal')).show();
  }, 300);
}

function switchToRegister() {
  const loginModal = bootstrap.Modal.getInstance(document.getElementById('loginModal'));
  if (loginModal) loginModal.hide();
  
  setTimeout(() => {
    new bootstrap.Modal(document.getElementById('registerModal')).show();
  }, 300);
}

// ======================
// CARRITO
// ======================

function addToCart(productId) {
  if (!state.currentUser) {
    showLoginModal();
    return;
  }
  
  const product = state.products.find(p => p.id === productId);
  if (!product || product.stock <= 0) {
    showToast('❌ No disponible', 'error');
    return;
  }
  
  const existing = state.cart.find(i => i.productId === productId);
  if (existing) {
    if (existing.quantity < product.stock) {
      existing.quantity++;
      showToast('✅ Actualizado', 'success');
    } else {
      showToast('❌ Sin stock', 'error');
      return;
    }
  } else {
    state.cart.push({ id: Date.now(), productId, quantity: 1, price: product.price });
    showToast('✅ Agregado', 'success');
  }
  
  updateCartUI();
  saveState();
}

function updateCartUI() {
  const badge = document.getElementById('cartBadge');
  const total = state.cart.reduce((sum, i) => sum + i.quantity, 0);
  if (total > 0) {
    badge.textContent = total;
    badge.classList.remove('hidden');
  } else {
    badge.classList.add('hidden');
  }
}

function showTopupModal() {
  if (!state.currentUser) {
    showToast('❌ Inicia sesión primero', 'error');
    showLoginModal();
    return;
  }
  
  // Mostrar saldo actual en el modal
  document.getElementById('currentBalanceInModal').textContent = state.currentUser.balance;
  
  // Resetear modal
  document.getElementById('topupAmountSelection').style.display = 'block';
  document.getElementById('topupPaymentMethods').classList.add('hidden');
  document.getElementById('topupLoading').classList.add('hidden');
  document.getElementById('topupSuccess').classList.add('hidden');
  document.getElementById('customTopupAmount').value = '';
  document.getElementById('proceedToPayment').disabled = true;
  
  // Quitar selección de botones
  document.querySelectorAll('.topup-amount-btn').forEach(btn => btn.classList.remove('active'));
  
  // Resetear variables
  topupAmount = 0;
  selectedPaymentMethod = null;
  
  new bootstrap.Modal(document.getElementById('topupModal')).show();
}

async function processTopupPayment() {
  if (!selectedPaymentMethod || selectedPaymentMethod !== 'mercadopago') {
    showToast('⚠️ Error en el método de pago', 'error');
    return;
  }
  
  if (!topupAmount || topupAmount < 100) {
    showToast('❌ Monto mínimo $100', 'error');
    return;
  }
  
  document.getElementById('topupPaymentMethods').classList.add('hidden');
  document.getElementById('topupLoading').classList.remove('hidden');
  
  try {
    // Simulación de procesamiento con MercadoPago
    await new Promise(resolve => setTimeout(resolve, 2000));
    
    // Simular transacción exitosa
    state.currentUser.balance += topupAmount;
    
    // Guardar transacción
    state.orders.push({
      id: Date.now(),
      userId: state.currentUser.id,
      type: 'topup',
      items: [],
      total: topupAmount,
      paymentMethod: 'mercadopago',
      timestamp: new Date().toISOString(),
      status: 'completed'
    });
    
    // Actualizar saldo en Firestore
    if (db && state.currentUser) {
      await db.collection('users').doc(state.currentUser.id).update({
        balance: state.currentUser.balance
      });
    }
    
    await saveState();
    
    document.getElementById('topupLoading').classList.add('hidden');
    document.getElementById('topupSuccess').classList.remove('hidden');
    document.getElementById('topupDetails').innerHTML = `
      <div class="glass-light p-3 rounded mt-3">
        <div class="mb-2"><strong>💰 Monto recargado:</strong> $${topupAmount}</div>
        <div class="mb-2"><strong>💳 Método:</strong> MercadoPago</div>
        <div class="mb-2"><strong>✅ Estado:</strong> <span class="text-success">Aprobado</span></div>
        <div class="mb-2"><strong>🆔 ID Transacción:</strong> #${Date.now()}</div>
        <div class="mb-2"><strong>💵 Nuevo saldo:</strong> <span class="price-tag">$${state.currentUser.balance}</span></div>
        <div class="text-xs text-slate-400 mt-2">
          <i class="fas fa-info-circle"></i> Esta es una simulación. La integración real con MercadoPago se agregará próximamente.
        </div>
      </div>
    `;
    
    updateUI();
    
    setTimeout(() => {
      createConfetti();
      bootstrap.Modal.getInstance(document.getElementById('topupModal')).hide();
      showToast(`🎉 $${topupAmount} agregados a tu saldo`, 'success');
      
      // Resetear
      topupAmount = 0;
      selectedPaymentMethod = null;
      
      // Resetear modal
      setTimeout(() => {
        document.getElementById('topupAmountSelection').style.display = 'block';
        document.getElementById('topupPaymentMethods').classList.add('hidden');
        document.getElementById('topupSuccess').classList.add('hidden');
      }, 300);
    }, 3000);
  } catch (error) {
    handleError(error, 'Recarga');
    document.getElementById('topupLoading').classList.add('hidden');
    document.getElementById('topupPaymentMethods').classList.remove('hidden');
  }
}



function showCartModal() {
  renderCartItems();
  new bootstrap.Modal(document.getElementById('cartModal')).show();
}
// ======================
// MERCADOPAGO
// ======================

function showMercadoPagoModal() {
  if (!state.currentUser || !state.cart.length) {
    showToast('Carrito vacío', 'error');
    return;
  }
  renderPaymentSummary();
  
  // Auto-seleccionar MercadoPago
  selectedPaymentMethod = 'mercadopago';
  
  document.getElementById('paymentMethods').innerHTML = `
    <div class="payment-method selected" data-method="mercadopago">
      <i class="fab fa-cc-mastercard fa-3x mb-2 text-blue-400"></i>
      <div class="font-semibold">MercadoPago</div>
      <small class="text-slate-400">Tarjetas de crédito y débito</small>
    </div>
  `;
  
  document.getElementById('confirmPayment').disabled = false;
  document.getElementById('confirmPayment').innerHTML = '<i class="fas fa-lock"></i> Pagar con MercadoPago';
  
  new bootstrap.Modal(document.getElementById('mpModal')).show();
  
  document.getElementById('confirmPayment').onclick = processCartPayment;
  document.getElementById('cancelPayment').onclick = () => {
    bootstrap.Modal.getInstance(document.getElementById('mpModal')).hide();
  };
}

function processCartPayment() {
  if (!selectedPaymentMethod) {
    showToast('⚠️ Selecciona método', 'error');
    return;
  }
  
  document.getElementById('paymentSummary').style.display = 'none';
  document.getElementById('paymentMethods').style.display = 'none';
  document.getElementById('paymentActions').style.display = 'none';
  document.getElementById('paymentLoading').classList.remove('hidden');
  
  setTimeout(() => {
    const total = state.cart.reduce((sum, i) => sum + (i.quantity * i.price), 0);
    
    state.cart.forEach(item => {
      const p = state.products.find(pr => pr.id === item.productId);
      if (p) p.stock -= item.quantity;
    });
    
    state.orders.push({
      id: Date.now(),
      userId: state.currentUser.id,
      items: [...state.cart],
      total,
      paymentMethod: selectedPaymentMethod,
      timestamp: new Date().toISOString()
    });
    
    state.cart = [];
    
    document.getElementById('paymentLoading').classList.add('hidden');
    document.getElementById('paymentSuccess').classList.remove('hidden');
    document.getElementById('paymentDetails').innerHTML = `<div class="glass-light p-3 rounded mt-3"><div><strong>ID:</strong> #${Date.now()}</div><div><strong>Método:</strong> ${getPaymentMethodName(selectedPaymentMethod)}</div><div><strong>Total:</strong> $${total}</div></div>`;
    
    updateCartUI();
    renderProducts();
    saveState();
    
    const cartModal = bootstrap.Modal.getInstance(document.getElementById('cartModal'));
    if (cartModal) cartModal.hide();
    
    setTimeout(() => {
      createConfetti();
      bootstrap.Modal.getInstance(document.getElementById('mpModal')).hide();
      resetPaymentModal();
      showToast('✅ Pago exitoso', 'success');
    }, 2500);
  }, 2000);
}

function resetPaymentModal() {
  selectedPaymentMethod = null;
  document.getElementById('paymentSummary').style.display = 'block';
  document.getElementById('paymentMethods').style.display = 'block';
  document.getElementById('paymentActions').style.display = 'flex';
  document.getElementById('paymentLoading').classList.add('hidden');
  document.getElementById('paymentSuccess').classList.add('hidden');
  document.getElementById('confirmPayment').disabled = true;
  document.getElementById('confirmPayment').innerHTML = '<i class="fas fa-lock"></i> Pagar';
  document.querySelectorAll('#mpModal .payment-method').forEach(m => m.classList.remove('selected'));
}

function renderCartItems() {
  const items = document.getElementById('cartItems');
  const empty = document.getElementById('cartEmpty');
  const summary = document.getElementById('cartSummary');
  const total = document.getElementById('cartTotal');
  
  if (!state.cart.length) {
    items.innerHTML = '';
    empty.classList.remove('hidden');
    summary.style.display = 'none';
    return;
  }
  
  empty.classList.add('hidden');
  summary.style.display = 'block';
  
  let totalAmount = 0;
  items.innerHTML = state.cart.map(item => {
    const p = state.products.find(pr => pr.id === item.productId);
    if (!p) return '';
    const itemTotal = item.quantity * item.price;
    totalAmount += itemTotal;
    return `
      <div class="cart-item">
        <div class="flex gap-3">
          <img src="${p.image}" loading="lazy" alt="${sanitizeHTML(p.title)}" class="w-16 h-16 object-cover rounded">
          <div class="flex-grow">
            <h6 class="font-semibold">${sanitizeHTML(p.title)}</h6>
            <p class="text-sm text-slate-400">$${item.price} c/u</p>
            <div class="quantity-controls mt-2">
              <button class="quantity-btn" onclick="updateCartQuantity(${item.id}, -1)" ${item.quantity <= 1 ? 'disabled' : ''}><i class="fas fa-minus"></i></button>
              <span class="px-3">${item.quantity}</span>
              <button class="quantity-btn" onclick="updateCartQuantity(${item.id}, 1)" ${item.quantity >= p.stock ? 'disabled' : ''}><i class="fas fa-plus"></i></button>
              <button class="quantity-btn ml-2" onclick="removeFromCart(${item.id})"><i class="fas fa-trash"></i></button>
            </div>
          </div>
          <div class="font-semibold">$${itemTotal}</div>
        </div>
      </div>
    `;
  }).join('');
  
  total.textContent = `$${totalAmount}`;
}

async function checkout() {
  if (!state.currentUser || !state.cart.length) return;
  
  const total = state.cart.reduce((sum, i) => sum + (i.quantity * i.price), 0);
  
  showLoading('Procesando compra...');
  
  try {
    // Procesar cada item del carrito
    state.cart.forEach(item => {
      const p = state.products.find(pr => pr.id === item.productId);
      if (p) {
        p.stock -= item.quantity;
        
        // Crear notificación por cada producto
        createNotification('purchase_made', {
          itemId: p.id,
          itemName: p.title,
          itemImage: p.image,
          amount: item.quantity * item.price,
          quantity: item.quantity,
          paymentStatus: 'pending'
        });
      }
    });
    
    // Limpiar carrito
    state.cart = [];
    
    await saveState();
    
    bootstrap.Modal.getInstance(document.getElementById('cartModal')).hide();
    createConfetti();
    updateUI();
    updateCartUI();
    renderProducts();
    
    showToast('✅ Compra realizada! Revisa tu bandeja de entrada para pagar', 'success');
    
    // Abrir bandeja automáticamente
    setTimeout(() => {
      showInboxModal();
    }, 1500);
    
  } catch (error) {
    handleError(error, 'Checkout');
  } finally {
    hideLoading();
  }
}

// ======================
// MERCADOPAGO
// ======================

function showMercadoPagoModal() {
  if (!state.currentUser || !state.cart.length) {
    showToast('Carrito vacío', 'error');
    return;
  }
  renderPaymentSummary();
  
  // Auto-seleccionar MercadoPago
  selectedPaymentMethod = 'mercadopago';
  
  document.getElementById('paymentMethods').innerHTML = `
    <div class="payment-method selected" data-method="mercadopago">
      <i class="fab fa-cc-mastercard fa-3x mb-2 text-blue-400"></i>
      <div class="font-semibold">MercadoPago</div>
      <small class="text-slate-400">Tarjetas de crédito y débito</small>
    </div>
  `;
  
  document.getElementById('confirmPayment').disabled = false;
  document.getElementById('confirmPayment').innerHTML = '<i class="fas fa-lock"></i> Pagar con MercadoPago';
  
  new bootstrap.Modal(document.getElementById('mpModal')).show();
  
  document.getElementById('confirmPayment').onclick = processCartPayment;
  document.getElementById('cancelPayment').onclick = () => {
    bootstrap.Modal.getInstance(document.getElementById('mpModal')).hide();
  };
}

function processCartPayment() {
  if (!selectedPaymentMethod) {
    showToast('⚠️ Selecciona método', 'error');
    return;
  }
  
  document.getElementById('paymentSummary').style.display = 'none';
  document.getElementById('paymentMethods').style.display = 'none';
  document.getElementById('paymentActions').style.display = 'none';
  document.getElementById('paymentLoading').classList.remove('hidden');
  
  setTimeout(() => {
    const total = state.cart.reduce((sum, i) => sum + (i.quantity * i.price), 0);
    
    state.cart.forEach(item => {
      const p = state.products.find(pr => pr.id === item.productId);
      if (p) p.stock -= item.quantity;
    });
    
    state.orders.push({
      id: Date.now(),
      userId: state.currentUser.id,
      items: [...state.cart],
      total,
      paymentMethod: selectedPaymentMethod,
      timestamp: new Date().toISOString()
    });
    
    state.cart = [];
    
    document.getElementById('paymentLoading').classList.add('hidden');
    document.getElementById('paymentSuccess').classList.remove('hidden');
    document.getElementById('paymentDetails').innerHTML = `<div class="glass-light p-3 rounded mt-3"><div><strong>ID:</strong> #${Date.now()}</div><div><strong>Método:</strong> ${getPaymentMethodName(selectedPaymentMethod)}</div><div><strong>Total:</strong> $${total}</div></div>`;
    
    updateCartUI();
    renderProducts();
    saveState();
    
    const cartModal = bootstrap.Modal.getInstance(document.getElementById('cartModal'));
    if (cartModal) cartModal.hide();
    
    setTimeout(() => {
      createConfetti();
      bootstrap.Modal.getInstance(document.getElementById('mpModal')).hide();
      resetPaymentModal();
      showToast('✅ Pago exitoso', 'success');
    }, 2500);
  }, 2000);
}

function resetPaymentModal() {
  selectedPaymentMethod = null;
  document.getElementById('paymentSummary').style.display = 'block';
  document.getElementById('paymentMethods').style.display = 'block';
  document.getElementById('paymentActions').style.display = 'flex';
  document.getElementById('paymentLoading').classList.add('hidden');
  document.getElementById('paymentSuccess').classList.add('hidden');
  document.getElementById('confirmPayment').disabled = true;
  document.getElementById('confirmPayment').innerHTML = '<i class="fas fa-lock"></i> Pagar';
  document.querySelectorAll('#mpModal .payment-method').forEach(m => m.classList.remove('selected'));
}

// ======================
// PUJAS
// ======================

function openBidModal(auctionId) {
  if (!state.currentUser) {
    showLoginModal();
    return;
  }
  
  const auction = state.auctions.find(a => a.id === auctionId);
  if (!auction) return;
  
  // Validar que la subasta esté activa
  if (auction.status !== 'active') {
    showToast('❌ Esta subasta ya finalizó', 'error');
    return;
  }
  
  // Validar que no haya expirado el tiempo
  const now = new Date();
  const endTime = new Date(auction.endTime);
  if (now >= endTime) {
    showToast('⏱️ Esta subasta ya terminó', 'warning');
    // Actualizar estado de la subasta
    auction.status = 'ended';
    saveState();
    renderAuctions();
    renderFeaturedAuction();
    return;
  }
  
  document.getElementById('bidAuctionId').value = auctionId;
  document.getElementById('bidAuctionInfo').innerHTML = `<div class="flex gap-3 p-3 bg-slate-800/30 rounded"><img src="${auction.image}" loading="lazy" alt="${sanitizeHTML(auction.title)}" class="w-12 h-12 object-cover rounded"><div><div class="font-semibold">${sanitizeHTML(auction.title)}</div><div class="text-sm text-slate-400">Actual: $${auction.currentBid || auction.startPrice}</div></div></div>`;
  
  const currentBid = auction.currentBid || auction.startPrice;
  const minBid = currentBid + 500;
  const roundedMin = Math.ceil(minBid / 500) * 500;

  const bidInput = document.getElementById('bidAmount');
  bidInput.value = roundedMin;
  bidInput.min = roundedMin;
  bidInput.step = 500;
  
  // Configurar botones de incremento
  document.querySelectorAll('#bidModal .increment-btn').forEach(btn => {
    btn.onclick = function() {
      const increment = parseInt(this.dataset.amount);
      document.getElementById('bidAmount').value = currentBid + increment;
    };
  });
  
  new bootstrap.Modal(document.getElementById('bidModal')).show();
}

// ✅ FUNCIÓN COMPLETA PARA ENVIAR PUJAS
async function submitBid() {
  const bidInput = document.getElementById('bidAmount');
  const amount = parseInt(bidInput.value);
  const auctionId = parseInt(document.getElementById('bidAuctionId').value);
  
  if (!state.currentUser) {
    showToast('❌ Debes iniciar sesión para pujar', 'error');
    return;
  }
  
  if (!amount || amount <= 0) {
    showToast('❌ Ingresa un monto válido', 'error');
    return;
  }
  
  const auction = state.auctions.find(a => a.id === auctionId);
  if (!auction) {
    showToast('❌ Subasta no encontrada', 'error');
    return;
  }
  
  // Validar monto mínimo
  const currentBid = auction.currentBid || auction.startPrice;
  const minBid = currentBid + 500;
  
  if (amount < minBid) {
    showToast(`❌ La puja mínima es $${minBid}`, 'error');
    return;
  }
  
  // Validar saldo suficiente
  if (state.currentUser.balance < amount) {
    showToast('❌ Saldo insuficiente', 'error');
    showAddFundsModal();
    return;
  }
  
  showLoading();
  
  try {
    const bidId = state.bids.length + 1;
    const timestamp = new Date().toISOString();

    // Buscar puja anterior del usuario en esta subasta
    const previousBid = state.bids
      .filter(b => b.auctionId === auctionId && b.userId === state.currentUser.id)
      .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))[0];
    
    // 💰 Debitar saldo del usuario
    state.currentUser.balance -= amount;
    
    // Si había una puja anterior, devolver ese monto
    if (previousBid) {
      state.currentUser.balance += previousBid.amount;
      showToast(`💸 Se devolvió tu puja anterior de $${previousBid.amount}`, 'info');
    }

    // Agregar nueva puja
    state.bids.push({
      id: bidId,
      auctionId,
      userId: state.currentUser.id,
      amount,
      timestamp
    });

    // Actualizar subasta
    if (!auction.bids) auction.bids = [];
    auction.bids.push(state.currentUser.id);
    auction.currentBid = amount;
    auction.lastBidTime = timestamp;
    
    // Actualizar saldo en Firestore si está disponible
    if (db && state.currentUser) {
      await db.collection('users').doc(state.currentUser.id).update({
        balance: state.currentUser.balance
      });
    }
    
    // Guardar estado
    await saveState();
    
    // Cerrar modal y mostrar feedback
    const bidModal = bootstrap.Modal.getInstance(document.getElementById('bidModal'));
    if (bidModal) bidModal.hide();
    
    createConfetti();
    renderAuctions();
    renderFeaturedAuction();
    updateUI();
    showToast('✅ Puja realizada exitosamente', 'success');
    
  } catch (error) {
    console.error('Error en submitBid:', error);
    showToast('❌ Error al realizar la puja', 'error');
  } finally {
    hideLoading();
  }
}

// 🔗 Conectar el botón "Ofertar" del modal a la función
document.addEventListener('DOMContentLoaded', function() {
  const bidButton = document.querySelector('#bidModal .btn-primary');
  if (bidButton) {
    bidButton.onclick = submitBid;
  }
});


async function placeBid(e) {
  e.preventDefault();
  
  if (!state.currentUser) {
    showToast('❌ Debes iniciar sesión para pujar', 'error');
    return;
  }
  
  const auctionId = parseInt(document.getElementById('bidAuctionId').value);
  const amount = parseInt(document.getElementById('bidAmount').value);
  
  const auction = state.auctions.find(a => a.id === auctionId);
  if (!auction) {
    showToast('❌ Subasta no encontrada', 'error');
    return;
  }
  
  // Validar que la subasta esté activa
  if (auction.status !== 'active') {
    showToast('❌ Esta subasta ya finalizó', 'error');
    return;
  }
  
  // Validar monto mínimo
  const currentBid = auction.currentBid || auction.startPrice;
  const minBid = currentBid + 500;
  
  if (amount < minBid) {
    showToast(`❌ La puja mínima es $${minBid}`, 'error');
    return;
  }
  
  // Validar saldo
  if (state.currentUser.balance < amount) {
    showToast('❌ Saldo insuficiente', 'error');
    showTopupModal();
    return;
  }
  
  showLoading('Procesando puja...');
  
  try {
    // Buscar puja anterior del usuario
    const previousBids = state.bids.filter(b => 
      b.auctionId === auctionId && b.userId === state.currentUser.id
    );
    const previousBid = previousBids.length > 0 ? 
      previousBids.reduce((max, b) => b.amount > max.amount ? b : max) : null;
    
    // Debitar nuevo monto
    state.currentUser.balance -= amount;
    
    // Devolver puja anterior si existe
    if (previousBid) {
      state.currentUser.balance += previousBid.amount;
    }
    
    // Crear nueva puja
    const newBid = {
      id: Date.now(),
      auctionId: auctionId,
      userId: state.currentUser.id,
      amount: amount,
      timestamp: new Date().toISOString()
    };
    
    state.bids.push(newBid);
    
    // Actualizar subasta
    if (!auction.bids) auction.bids = [];
    auction.bids.push(state.currentUser.id);
    auction.currentBid = amount;
    auction.lastBidTime = new Date().toISOString();
    
    // Actualizar en Firestore
    if (db && state.currentUser) {
      await db.collection('users').doc(state.currentUser.id).update({
        balance: state.currentUser.balance
      });
    }
    
    await saveState();
    
    // Cerrar modal y mostrar resultado
    bootstrap.Modal.getInstance(document.getElementById('bidModal')).hide();
    
    createConfetti();
    renderAuctions();
    renderFeaturedAuction();
    updateUI();
    
    showToast('✅ Puja realizada exitosamente!', 'success');
    
  } catch (error) {
    console.error('Error en placeBid:', error);
    showToast('❌ Error al procesar la puja', 'error');
  } finally {
    hideLoading();
  }
}

async function buyNow(auctionId) {
  if (!state.currentUser) {
    showLoginModal();
    return;
  }
  
  const auction = state.auctions.find(a => a.id === auctionId);
  if (!auction || !auction.buyNowPrice) return;
  
  if (state.currentUser.balance < auction.buyNowPrice) {
    showToast('⌛ Saldo insuficiente', 'error');
    showTopupModal();
    return;
  }
  
  if (confirm(`¿Comprar "${auction.title}" por $${auction.buyNowPrice}?`)) {
    showLoading('Procesando compra...');
    
    try {
      state.currentUser.balance -= auction.buyNowPrice;
      auction.status = 'sold';
      auction.winner = state.currentUser.id;
      auction.finalPrice = auction.buyNowPrice;
      
      createNotification('auction_won', {
        itemId: auction.id,
        itemName: auction.title,
        itemImage: auction.image,
        amount: auction.buyNowPrice,
        paymentStatus: 'paid'
      });
      
      await saveState();
      createConfetti();
      renderAuctions();
      renderFeaturedAuction();
      updateUI();
      showToast('🎉 ¡Compra exitosa!', 'success');
      
    } catch (error) {
      state.currentUser.balance += auction.buyNowPrice;
      handleError(error, 'Compra directa');
    } finally {
      hideLoading();
    }
  }
}

// ======================
// FILTROS
// ======================

function filterProducts() {
  const search = document.getElementById('searchProducts')?.value.toLowerCase() || '';
  const category = document.getElementById('filterProductCategory')?.value || 'all';
  const sortBy = document.getElementById('sortProducts')?.value || 'newest'; // ⬅️ FALTABA ESTA LÍNEA
  
  let filtered = state.products.filter(p => {
    const matchSearch = p.title.toLowerCase().includes(search) || 
                        p.description.toLowerCase().includes(search);
    const matchCategory = category === 'all' || p.category === category;
    return matchSearch && matchCategory;
  });
  
  if (sortBy === 'price-asc') {
    filtered.sort((a, b) => a.price - b.price);
  } else if (sortBy === 'price-desc') {
    filtered.sort((a, b) => b.price - a.price);
  } else {
    filtered.sort((a, b) => b.id - a.id);
  }
  
  renderProducts(filtered);
}

// ======================
// FUNCIONES DE FILTRADO
// ======================

function filterAuctions() {
  const search = document.getElementById('searchAuctions')?.value.toLowerCase() || '';
  const sortBy = document.getElementById('sortAuctions')?.value || 'ending';
  const filterState = document.getElementById('filterAuctionState')?.value || 'all';
  
  let filtered = state.auctions.filter(a => {
    const matchSearch = a.title.toLowerCase().includes(search) || a.description.toLowerCase().includes(search);
    const matchState = filterState === 'all' || a.status === filterState;
    return matchSearch && matchState;
  });
  
  if (sortBy === 'highest') {
    filtered.sort((a, b) => (b.currentBid || b.startPrice) - (a.currentBid || a.startPrice));
  } else if (sortBy === 'newest') {
    filtered.sort((a, b) => new Date(b.lastBidTime) - new Date(a.lastBidTime));
  } else {
    filtered.sort((a, b) => new Date(a.endTime) - new Date(b.endTime));
  }
  
  renderAuctions(filtered);
}
// ======================
// FUNCIONES DE INTERFAZ MÓVIL
// ======================

function setupMobileMenu() {
  const menuItems = document.querySelectorAll('.mobile-menu-item');
  
  menuItems.forEach(item => {
    item.addEventListener('click', function() {
      // Remover activo de todos los items
      menuItems.forEach(i => i.classList.remove('active'));
      
      // Agregar activo al item clickeado
      this.classList.add('active');
      
      const target = this.dataset.target;
      
      // Navegar según el target
      switch(target) {
        case 'auctions':
          document.getElementById('auctions-tab').click();
          window.scrollTo({ top: 0, behavior: 'smooth' });
          break;
        case 'store':
          document.getElementById('store-tab').click();
          window.scrollTo({ top: 0, behavior: 'smooth' });
          break;
        case 'cart':
          showCartModal();
          break;
      }
    });
  });
}

// ======================
// EFECTOS VISUALES
// ======================

function initParticles() {
  const container = document.getElementById('particles-js');
  if (!container) return;
  
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');
  
  canvas.style.cssText = 'position:absolute;top:0;left:0;width:100%;height:100%;z-index:-1';
  container.appendChild(canvas);
  
  function resize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
  }
  
  resize();
  window.addEventListener('resize', resize);
  
  const particles = [];
  const particleCount = 30; // Reducido para mejor rendimiento
  
  // Crear partículas
  for (let i = 0; i < particleCount; i++) {
    particles.push({
      x: Math.random() * canvas.width,
      y: Math.random() * canvas.height,
      vx: (Math.random() - 0.5) * 1.5, // Velocidad reducida
      vy: (Math.random() - 0.5) * 1.5,
      size: Math.random() * 2 + 1,
      opacity: Math.random() * 0.4 + 0.1
    });
  }
  
  function animate() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    particles.forEach(p => {
      // Actualizar posición
      p.x += p.vx;
      p.y += p.vy;
      
      // Rebotar en los bordes
      if (p.x <= 0 || p.x >= canvas.width) p.vx *= -1;
      if (p.y <= 0 || p.y >= canvas.height) p.vy *= -1;
      
      // Mantener dentro de los límites
      p.x = Math.max(0, Math.min(canvas.width, p.x));
      p.y = Math.max(0, Math.min(canvas.height, p.y));
      
      // Dibujar partícula
      ctx.beginPath();
      ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
      ctx.fillStyle = `rgba(255, 62, 127, ${p.opacity})`;
      ctx.fill();
    });
    
    requestAnimationFrame(animate);
  }
  
  animate();
}

// ======================
// SISTEMA DE BOTS
// ======================

function startBotActivity() {
  if (botActivityInterval) clearInterval(botActivityInterval);
  
  botActivityInterval = setInterval(() => {
    if (!state.botSettings.enabled || !state.currentUser) return;
    
    const activeAuctions = state.auctions.filter(a => a.status === 'active');
    
    activeAuctions.forEach(auction => {
      const activeBots = state.botUsers.filter(b => {
        if (!b.active || b.balance <= (auction.currentBid || auction.startPrice) + 50) return false;
        const botDelay = (b.delay || state.botSettings.delayGlobal) * 60000;
        const timeSince = new Date() - new Date(auction.lastBidTime);
        return timeSince >= botDelay;
      });
      
      if (!activeBots.length) return;
      
      if (Math.random() * 100 <= state.botSettings.probability) {
        const bot = activeBots[Math.floor(Math.random() * activeBots.length)];
        const bidAmount = (auction.currentBid || auction.startPrice) + 500 + (Math.floor(Math.random() * 3) * 100);
        
        if (bot.balance >= bidAmount) {
          // Descontar saldo del bot
          bot.balance -= bidAmount;
          
          state.bids.push({ 
            id: state.bids.length + 1, 
            auctionId: auction.id, 
            userId: bot.id, 
            amount: bidAmount, 
            timestamp: new Date().toISOString() 
          });
          
          auction.bids.push(bot.id);
          auction.currentBid = bidAmount;
          auction.lastBidTime = new Date().toISOString();
          
          // Guardar inmediatamente
          saveState();
          
          // Mostrar notificación SOLO A ADMINS
          if (state.currentUser?.role === 'admin') {
            showToast(`🤖 ${bot.name} pujó $${bidAmount}`, 'info');
          }
        }
      }
    });
  }, 30000); // Verificar cada 30 segundos
}
// ======================
// CONFIGURACIÓN DE LISTENERS
// ======================

function setupListeners() {
  // Helper para asignar eventos de forma segura
  function safeAssign(id, event, handler) {
    const element = document.getElementById(id);
    if (element) {
      element[event] = handler;
    } else {
      console.warn(`⚠️ Elemento no encontrado: ${id}`);
    }
  }
  
  // Auth y perfil
  safeAssign('loginBtn', 'onclick', showLoginModal);
  safeAssign('registerBtn', 'onclick', showRegisterModal);
  safeAssign('logoutBtn', 'onclick', logout);
  safeAssign('loginForm', 'onsubmit', handleLogin);
  
  // Registro
  safeAssign('registerForm', 'onsubmit', handleRegister);
  safeAssign('switchToRegister', 'onclick', (e) => {
    e.preventDefault();
    switchToRegister();
  });
  safeAssign('switchToLogin', 'onclick', (e) => {
    e.preventDefault();
    switchToLogin();
  });
  
  // Términos y condiciones
  const termsLink = document.getElementById('openTermsLink');
  if (termsLink) {
    termsLink.onclick = (e) => {
      e.preventDefault();
      new bootstrap.Modal(document.getElementById('termsModal')).show();
    };
  }
  
  // Perfil
  safeAssign('profileBtn', 'onclick', () => {
    if (!state.currentUser) return;
    const nameInput = document.getElementById('profileName');
    const emailInput = document.getElementById('profileEmail');
    if (nameInput) nameInput.value = state.currentUser.name || '';
    if (emailInput) emailInput.value = state.currentUser.email || '';
    new bootstrap.Modal(document.getElementById('profileModal')).show();
  });

  safeAssign('profileForm', 'onsubmit', (e) => {
    e.preventDefault();
    const nameInput = document.getElementById('profileName');
    if (nameInput && state.currentUser) {
      state.currentUser.name = nameInput.value;
      saveState();
      updateUI();
      bootstrap.Modal.getInstance(document.getElementById('profileModal')).hide();
      showToast('Perfil actualizado', 'success');
    }
  });
  
  // Carrito y pagos
  safeAssign('cartBtn', 'onclick', showCartModal);
  safeAssign('inboxBtn', 'onclick', showInboxModal);
  safeAssign('checkoutBtn', 'onclick', checkout);
  safeAssign('mercadopagoBtn', 'onclick', showMercadoPagoModal);
  
  // Admin
  safeAssign('btnCreateDemo', 'onclick', createDemoData);
  safeAssign('openAdmin', 'onclick', toggleAdminPanel);
  safeAssign('topup', 'onclick', showTopupModal);
  
  // Formularios
  safeAssign('createAuctionForm', 'onsubmit', createAuction);
  safeAssign('bidForm', 'onsubmit', placeBid);
  safeAssign('createProductForm', 'onsubmit', createProduct);
  
  // Filtros
  safeAssign('searchAuctions', 'oninput', debounce(filterAuctions, 300));
  safeAssign('sortAuctions', 'onchange', filterAuctions);
  safeAssign('filterAuctionState', 'onchange', filterAuctions);
  safeAssign('searchProducts', 'oninput', debounce(filterProducts, 300));
  safeAssign('filterProductCategory', 'onchange', filterProducts);
  safeAssign('sortProducts', 'onchange', filterProducts);
  safeAssign('filterCategory', 'onchange', filterAuctions);
  safeAssign('filterTime', 'onchange', filterAuctions);
}

function setupAuthListeners() {
  // Botones principales
  const loginBtn = document.getElementById('loginBtn');
  const registerBtn = document.getElementById('registerBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  
  if (loginBtn) loginBtn.addEventListener('click', showLoginModal);
  if (registerBtn) registerBtn.addEventListener('click', showRegisterModal);
  if (logoutBtn) logoutBtn.addEventListener('click', logout);
  
  // Formularios
  const loginForm = document.getElementById('loginForm');
  const registerForm = document.getElementById('registerForm');
  
  if (loginForm) loginForm.addEventListener('submit', handleLogin);
  if (registerForm) registerForm.addEventListener('submit', handleRegister);
  
  // Switches entre modales
  const switchToRegister = document.getElementById('switchToRegister');
  const switchToLogin = document.getElementById('switchToLogin');
  
  if (switchToRegister) {
    switchToRegister.addEventListener('click', function(e) {
      e.preventDefault();
      const loginModal = bootstrap.Modal.getInstance(document.getElementById('loginModal'));
      if (loginModal) loginModal.hide();
      setTimeout(() => new bootstrap.Modal(document.getElementById('registerModal')).show(), 300);
    });
  }
  
  if (switchToLogin) {
    switchToLogin.addEventListener('click', function(e) {
      e.preventDefault();
      const registerModal = bootstrap.Modal.getInstance(document.getElementById('registerModal'));
      if (registerModal) registerModal.hide();
      setTimeout(() => new bootstrap.Modal(document.getElementById('loginModal')).show(), 300);
    });
  }
}


// ======================
// FUNCIONES DEMO Y UTILIDADES
// ======================

function createDemoData() {
  const now = new Date();
  
  // Subastas demo
  const demoAuctions = [
    {
      id: Math.max(0, ...state.auctions.map(a => a.id)) + 1,
      title: 'iPhone 15 Pro Max',
      description: 'Nuevo en caja sellada, 256GB, color Natural Titanium',
      image: 'https://images.unsplash.com/photo-1592750475338-74b7b21085ab?w=400',
      category: 'Electrónicos',
      startPrice: 1000,
      currentBid: 1000,
      buyNowPrice: 2000,
      endTime: new Date(now.getTime() + 2 * 60 * 60 * 1000).toISOString(),
      sellerId: 'admin',
      bids: [],
      lastBidTime: now.toISOString(),
      status: 'active'
    },
    {
      id: Math.max(0, ...state.auctions.map(a => a.id)) + 2,
      title: 'PlayStation 5 Slim',
      description: 'Edición standard con control DualSense, 1TB',
      image: 'https://images.unsplash.com/photo-1606813907291-d86efa9b94db?w=400',
      category: 'Electrónicos',
      startPrice: 800,
      currentBid: 800,
      buyNowPrice: 1500,
      endTime: new Date(now.getTime() + 3 * 60 * 60 * 1000).toISOString(),
      sellerId: 'admin',
      bids: [],
      lastBidTime: now.toISOString(),
      status: 'active'
    }
  ];
  
  // Productos demo
  const demoProducts = [
    {
      id: Math.max(0, ...state.products.map(p => p.id)) + 1,
      title: 'Auriculares Sony WH-1000XM4',
      description: 'Cancelación de ruido activa, batería 30 horas',
      image: 'https://images.unsplash.com/photo-1505740420928-5e560c06d30e?w=400',
      category: 'Electrónicos',
      price: 350,
      stock: 8,
      featured: true
    },
    {
      id: Math.max(0, ...state.products.map(p => p.id)) + 2,
      title: 'Smartwatch Samsung Galaxy Watch 6',
      description: 'Resistente al agua, GPS, monitoreo de sueño',
      image: 'https://images.unsplash.com/photo-1523275335684-37898b6baf30?w=400',
      category: 'Electrónicos',
      price: 280,
      stock: 5,
      featured: false
    }
  ];
  
  // Agregar a los estados
  state.auctions.push(...demoAuctions);
  state.products.push(...demoProducts);
  
  // Guardar y actualizar UI
  saveState();
  renderAuctions();
  renderProducts();
  renderFeaturedAuction();
  updateCategoryFilter();
  
  showToast('🎉 Datos de demostración creados exitosamente!', 'success');
}

// ✅ AGREGAR ESTA FUNCIÓN NUEVA:
function renderDashboardStats() {
  // Contar subastas activas
  const activeAuctions = state.auctions.filter(a => 
    a.status === 'active' && new Date(a.endTime) > new Date()
  ).length;
  
  // Contar órdenes pagadas
  const paidOrders = state.orders.filter(o => o.status === 'completed').length;
  const paidAmount = state.orders
    .filter(o => o.status === 'completed')
    .reduce((sum, o) => sum + o.total, 0);
  
  // Órdenes pendientes
  const pendingOrders = state.orders.filter(o => o.status === 'pending').length;
  const pendingAmount = state.orders
    .filter(o => o.status === 'pending')
    .reduce((sum, o) => sum + o.total, 0);
  
  // Actualizar UI
  if (document.getElementById('statActiveAuctions')) {
    document.getElementById('statActiveAuctions').textContent = activeAuctions;
  }
  if (document.getElementById('statPaidOrders')) {
    document.getElementById('statPaidOrders').textContent = paidOrders;
  }
  if (document.getElementById('statPaidAmount')) {
    document.getElementById('statPaidAmount').textContent = paidAmount;
  }
  if (document.getElementById('statPendingOrders')) {
    document.getElementById('statPendingOrders').textContent = pendingOrders;
  }
  if (document.getElementById('statPendingAmount')) {
    document.getElementById('statPendingAmount').textContent = pendingAmount;
  }
}

function showAddFundsModal() {
  showTopupModal();
}

// ======================
// FUNCIONES DE ADMINISTRACIÓN
// ======================

async function createAuction(e) {
  e.preventDefault();
  
  if (!state.currentUser || state.currentUser.role !== 'admin') {
    showToast('❌ Solo administradores pueden crear subastas', 'error');
    return;
  }
  
  const title = document.getElementById('auctionTitle').value;
  const description = document.getElementById('auctionDescription').value;
  const startPrice = parseFloat(document.getElementById('auctionStartPrice').value);
  const buyNowPrice = document.getElementById('auctionBuyNow').value ? 
    parseFloat(document.getElementById('auctionBuyNow').value) : null;
  const duration = parseInt(document.getElementById('auctionDuration').value);
  const category = document.getElementById('auctionCategory').value;
  
  // Validar campos requeridos
  if (!title || !description || !startPrice || !duration || !category) {
    showToast('❌ Completa todos los campos requeridos', 'error');
    return;
  }
  
  // Validar que buyNowPrice sea mayor que startPrice si se especifica
  if (buyNowPrice && buyNowPrice <= startPrice) {
    showToast('❌ El precio de compra directa debe ser mayor al precio inicial', 'error');
    return;
  }
  
  showLoading('Creando subasta...');
  
  try {
    // Obtener imagen (usar URL o imagen por defecto)
    let imageUrl = document.getElementById('auctionImageURL').value;
    if (!imageUrl) {
      // Usar imagen por defecto si no se proporciona URL
      imageUrl = 'https://images.unsplash.com/photo-1560472354-b33ff0c44a43?w=500';
    }
    

    // Calcular fecha de finalización
    const endTime = new Date();
    endTime.setMinutes(endTime.getMinutes() + duration);
    
    // Crear nueva subasta
    const newAuction = {
      id: Math.max(0, ...state.auctions.map(a => a.id)) + 1,
      title: title,
      description: description,
      image: imageUrl,
      category: category,
      startPrice: startPrice,
      currentBid: startPrice,
      buyNowPrice: buyNowPrice,
      endTime: endTime.toISOString(),
      sellerId: state.currentUser.id,
      bids: [],
      lastBidTime: new Date().toISOString(),
      status: 'active'
    };
    
    // Agregar a las subastas
    state.auctions.push(newAuction);
    
    // Limpiar formulario
    document.getElementById('createAuctionForm').reset();
    
    // Guardar y actualizar
    await saveState();
    renderAuctions();
    renderFeaturedAuction();
    updateCategoryFilter();
    
    showToast('✅ Subasta creada exitosamente', 'success');
    
  } catch (error) {
    console.error('Error creando subasta:', error);
    showToast('❌ Error al crear la subasta', 'error');
  } finally {
    hideLoading();
  }
}

function toggleAdminPanel() {
  if (!state.currentUser || state.currentUser.role !== 'admin') {
    showToast('❌ Solo administradores pueden acceder', 'error');
    return;
  }
  
  const adminPanel = document.getElementById('adminPanel');
  const mainContent = document.querySelector('main');
  
  if (adminPanel.style.display === 'none' || !adminPanel.style.display) {
    adminPanel.style.display = 'block';
    if (mainContent) mainContent.style.display = 'none';
    showToast('🔧 Panel de administración activado', 'info');
    
    // Cargar datos del dashboard
    renderDashboardStats();
  } else {
    adminPanel.style.display = 'none';
    if (mainContent) mainContent.style.display = 'block';
  }
}

function hideAdminPanel() {
  const adminPanel = document.getElementById('adminPanel');
  const mainContent = document.querySelector('main');
  
  if (adminPanel) adminPanel.style.display = 'none';
  if (mainContent) mainContent.style.display = 'block';
}

// INICIALIZACIÓN
// ======================

async function init() {
  console.log("🚀 Iniciando Subasta Argenta...");
  
  try {
    // Cargar estado inicial
    await loadState();
    
    // Configurar todos los listeners
    setupListeners();
    setupAuthListeners(); // ✅ AGREGAR ESTA LÍNEA
    
    // Inicializar UI
    updateUI();
    renderAuctions();
    renderProducts();
    renderFeaturedAuction();
    startCountdown();
    
    // Efectos visuales
    initParticles();
    setupMobileMenu();
    
    // Sistema de bots
    startBotActivity();
    
    // Configurar auth persistence
    setupAuthListener();
    
    console.log("✅ App completamente inicializada");
    
  } catch (error) {
    console.error('❌ Error en inicialización:', error);
    showToast('⚠️ Error al cargar la aplicación', 'error');
  }
}

// ======================
// FUNCIONES ADICIONALES DEL ADMIN PANEL
// ======================

function switchAdminTab(tabName) {
  // Ocultar todos los tabs
  document.querySelectorAll('.admin-tab-content').forEach(tab => {
    tab.style.display = 'none';
  });
  
  // Remover active de todos los tabs
  document.querySelectorAll('.admin-tab').forEach(tabBtn => {
    tabBtn.classList.remove('active');
  });
  
  // Mostrar tab seleccionado
  const selectedTab = document.getElementById(`adminTab${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`);
  if (selectedTab) {
    selectedTab.style.display = 'block';
  }
  
  // Activar botón del tab
  const activeTabBtn = Array.from(document.querySelectorAll('.admin-tab')).find(btn => 
    btn.textContent.includes(tabName.charAt(0).toUpperCase() + tabName.slice(1))
  );
  if (activeTabBtn) {
    activeTabBtn.classList.add('active');
  }
  
  // Cargar datos específicos del tab si es necesario
  switch(tabName) {
    case 'dashboard':
      renderDashboardStats();
      break;
    case 'won-auctions':
      renderWonAuctions();
      break;
    case 'purchases':
      renderPurchases();
      break;
    case 'auctions':
      renderAdminAuctionsList();
      break;
    case 'products':
      renderAdminProductsList();
      break;
    case 'users':
      renderAdminUsersList();
      break;
    case 'bots':
      renderAdminBotsList();
      break;
  }
}

function renderDashboardStats() {
  const activeAuctions = state.auctions.filter(a => a.status === 'active').length;
  const paidOrders = state.orders.filter(o => o.status === 'completed').length;
  
  if (document.getElementById('statActiveAuctions')) {
    document.getElementById('statActiveAuctions').textContent = activeAuctions;
  }
  if (document.getElementById('statPaidOrders')) {
    document.getElementById('statPaidOrders').textContent = paidOrders;
  }
}

// ======================
// SISTEMA DE NOTIFICACIONES
// ======================

function createNotification(type, data) {
  const notification = {
    id: Date.now(),
    type: type,
    data: data,
    timestamp: new Date().toISOString(),
    read: false
  };
  
  state.notifications.push(notification);
  updateInboxUI();
  saveState();
}

function updateInboxUI() {
  const badge = document.getElementById('inboxBadge');
  const unreadCount = state.notifications.filter(n => !n.read).length;
  
  if (badge) {
    if (unreadCount > 0) {
      badge.textContent = unreadCount;
      badge.classList.remove('hidden');
    } else {
      badge.classList.add('hidden');
    }
  }
}

function showInboxModal() {
  showToast('📬 Bandeja de entrada - En desarrollo', 'info');
}

// ======================
// FUNCIONES PARA DETALLES
// ======================

function showProductDetail(productId) {
  const product = state.products.find(p => p.id === productId);
  if (!product) return;
  
  const modalContent = `
    <div class="text-center">
      <img src="${product.image}" alt="${product.title}" class="w-full max-w-md mx-auto rounded-lg mb-4">
      <h4 class="font-bold text-xl mb-2">${product.title}</h4>
      <p class="text-slate-300 mb-4">${product.description}</p>
      <div class="price-tag text-2xl mb-4">$${product.price}</div>
      ${product.stock > 0 ? 
        `<button class="btn btn-primary w-full" onclick="addToCart(${product.id}); bootstrap.Modal.getInstance(document.getElementById('productDetailModal')).hide();">
          <i class="fas fa-cart-plus"></i> Agregar al Carrito
        </button>` : 
        '<button class="btn btn-secondary w-full" disabled>Agotado</button>'
      }
    </div>
  `;
  
  let modal = document.getElementById('productDetailModal');
  if (!modal) {
    modal = document.createElement('div');
    modal.id = 'productDetailModal';
    modal.className = 'modal fade';
    modal.innerHTML = `
      <div class="modal-dialog modal-md">
        <div class="modal-content glass border-0 rounded-2xl">
          <div class="modal-header border-slate-700">
            <h5 class="modal-title"><i class="fas fa-info-circle text-blue-400"></i> Detalles del Producto</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body" id="productDetailContent">
          </div>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
  }
  
  document.getElementById('productDetailContent').innerHTML = modalContent;
  new bootstrap.Modal(modal).show();
}

function showAuctionDetail(auctionId) {
  const auction = state.auctions.find(a => a.id === auctionId);
  if (!auction) return;
  
  showToast(`🔍 Vista detallada de "${auction.title}" - En desarrollo`, 'info');
}

// ======================
// FUNCIONES DE CARRITO MEJORADAS
// ======================

function updateCartQuantity(itemId, change) {
  const item = state.cart.find(i => i.id === itemId);
  if (!item) return;
  
  const product = state.products.find(p => p.id === item.productId);
  if (!product) return;
  
  const newQuantity = item.quantity + change;
  
  if (newQuantity < 1) {
    removeFromCart(itemId);
    return;
  }
  
  if (newQuantity > product.stock) {
    showToast('❌ No hay suficiente stock', 'error');
    return;
  }
  
  item.quantity = newQuantity;
  updateCartUI();
  renderCartItems();
  saveState();
}

function removeFromCart(itemId) {
  state.cart = state.cart.filter(i => i.id !== itemId);
  updateCartUI();
  renderCartItems();
  saveState();
  showToast('🗑️ Producto removido', 'info');
}

// ======================
// RENDERIZADO DEL ADMIN
// ======================

function renderAdminAuctionsList() {
  const list = document.getElementById('adminAuctionsList');
  if (!list) return;
  
  list.innerHTML = state.auctions.map(auction => `
    <div class="glass-light p-3 rounded mb-2">
      <div class="flex justify-between items-center">
        <div class="flex items-center gap-3">
          <img src="${auction.image}" alt="${auction.title}" class="w-12 h-12 object-cover rounded">
          <div>
            <div class="font-semibold">${auction.title}</div>
            <div class="text-xs text-slate-400">
              $${auction.currentBid || auction.startPrice} • 
              <span class="status-badge ${auction.status === 'active' ? 'pending' : 'paid'}">
                ${auction.status === 'active' ? 'Activa' : 'Finalizada'}
              </span>
            </div>
          </div>
        </div>
        <div class="flex gap-2">
          <button class="btn btn-sm btn-outline-warning" onclick="editAuction(${auction.id})">
            <i class="fas fa-edit"></i>
          </button>
          <button class="btn btn-sm btn-outline-danger" onclick="deleteAuction(${auction.id})">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      </div>
    </div>
  `).join('');
}

function renderAdminProductsList() {
  const list = document.getElementById('adminProductsList');
  if (!list) return;
  
  list.innerHTML = state.products.map(product => `
    <div class="glass-light p-3 rounded mb-2">
      <div class="flex justify-between items-center">
        <div class="flex items-center gap-3">
          <img src="${product.image}" alt="${product.title}" class="w-12 h-12 object-cover rounded">
          <div>
            <div class="font-semibold">${product.title}</div>
            <div class="text-xs text-slate-400">
              $${product.price} • Stock: ${product.stock}
            </div>
          </div>
        </div>
        <div class="flex gap-2">
          <button class="btn btn-sm btn-outline-warning" onclick="editProduct(${product.id})">
            <i class="fas fa-edit"></i>
          </button>
          <button class="btn btn-sm btn-outline-danger" onclick="deleteProduct(${product.id})">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      </div>
    </div>
  `).join('');
}

async function createProduct(e) {
  e.preventDefault();
  
  if (!state.currentUser || state.currentUser.role !== 'admin') {
    showToast('❌ Solo administradores pueden crear productos', 'error');
    return;
  }
  
  const title = document.getElementById('productTitle').value;
  const price = parseFloat(document.getElementById('productPrice').value);
  const stock = parseInt(document.getElementById('productStock').value);
  const category = document.getElementById('productCategory').value;
  const image = document.getElementById('productImage').value;
  const description = document.getElementById('productDescription').value;
  
  if (!title || !price || !stock || !category || !image || !description) {
    showToast('❌ Completa todos los campos', 'error');
    return;
  }
  
  showLoading('Creando producto...');
  
  try {
    const newProduct = {
      id: Math.max(0, ...state.products.map(p => p.id)) + 1,
      title,
      price,
      stock,
      category,
      image,
      description,
      featured: false
    };
    
    state.products.push(newProduct);
    document.getElementById('createProductForm').reset();
    
    await saveState();
    renderProducts();
    renderAdminProductsList();
    showToast('✅ Producto creado exitosamente', 'success');
    
  } catch (error) {
    handleError(error, 'Crear producto');
  } finally {
    hideLoading();
  }
}

// ======================
// INICIALIZAR GOOGLE MAPS
// ======================

function initGoogleMaps() {
  if (typeof google !== 'undefined' && google.maps) {
    initAutocomplete();
  } else {
    setTimeout(initGoogleMaps, 500);
  }
}

if (typeof google !== 'undefined') {
  initGoogleMaps();
} else {
  window.addEventListener('google-maps-ready', initGoogleMaps);
}
</script>

</body>
</html>